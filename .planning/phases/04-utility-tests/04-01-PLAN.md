---
phase: 04-utility-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/utils.test.ts
autonomous: true

must_haves:
  truths:
    - "safeParseISO returns Date for valid ISO strings"
    - "safeParseISO returns null for invalid strings, null, and undefined"
    - "safeFormatDate formats valid dates correctly"
    - "safeFormatDate returns fallback for invalid input"
    - "safeFormatDate accepts custom fallback string"
    - "All utility tests pass with npm test"
  artifacts:
    - path: "src/lib/utils.test.ts"
      provides: "Date utility function tests"
      contains: "describe('safeParseISO'"
    - path: "src/lib/utils.test.ts"
      provides: "Format utility function tests"
      contains: "describe('safeFormatDate'"
  key_links:
    - from: "src/lib/utils.test.ts"
      to: "src/lib/utils.ts"
      via: "import { safeParseISO, safeFormatDate }"
      pattern: "import.*safeParseISO.*safeFormatDate.*from"
---

<objective>
Add comprehensive tests for safeParseISO and safeFormatDate utilities to the existing utils.test.ts file.

Purpose: Validate that date parsing and formatting utilities handle all edge cases correctly, completing utility test coverage for Phase 4.
Output: Extended utils.test.ts with ~12-15 additional tests covering both date utilities.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source code to test
@src/lib/utils.ts

# Existing test file to extend (cn tests already present)
@src/lib/utils.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add safeParseISO tests</name>
  <files>src/lib/utils.test.ts</files>
  <action>
Add a new describe block for safeParseISO with the following test cases:

1. **Valid ISO strings:**
   - Returns Date object for "2024-01-15" (date only)
   - Returns Date object for "2024-01-15T10:30:00Z" (full ISO with Z)
   - Returns Date object for "2024-01-15T10:30:00.000Z" (with milliseconds)

2. **Invalid strings:**
   - Returns null for "not-a-date"
   - Returns null for "2024-13-45" (invalid month/day)
   - Returns null for "" (empty string)

3. **Null and undefined:**
   - Returns null for null input
   - Returns null for undefined input

Test assertions:
- Use `toBeInstanceOf(Date)` for valid dates
- Use `toBeNull()` for invalid inputs
- For valid dates, also verify the date value with `toEqual(new Date(...))` or check year/month/day

Import safeParseISO alongside cn in the existing import statement.
  </action>
  <verify>Run `npm test src/lib/utils.test.ts` - all safeParseISO tests pass</verify>
  <done>8 safeParseISO tests covering valid ISO strings, invalid strings, null, and undefined</done>
</task>

<task type="auto">
  <name>Task 2: Add safeFormatDate tests</name>
  <files>src/lib/utils.test.ts</files>
  <action>
Add a new describe block for safeFormatDate with the following test cases:

1. **Valid date formatting:**
   - Formats "2024-01-15" with "MMM d, yyyy" -> "Jan 15, 2024"
   - Formats "2024-01-15T10:30:00Z" with "yyyy-MM-dd" -> "2024-01-15"
   - Formats with "HH:mm" for time extraction

2. **Invalid input handling:**
   - Returns "No date" (default fallback) for null
   - Returns "No date" (default fallback) for undefined
   - Returns "No date" (default fallback) for "invalid-date"

3. **Custom fallback:**
   - Returns "N/A" when custom fallback "N/A" is provided for null
   - Returns "-" when custom fallback "-" is provided for invalid string

Test assertions:
- Use `toBe()` for string comparisons
- Verify exact formatted output strings

Import safeFormatDate in the same import statement as cn and safeParseISO.
  </action>
  <verify>Run `npm test src/lib/utils.test.ts` - all safeFormatDate tests pass</verify>
  <done>8 safeFormatDate tests covering valid formatting, invalid input, and custom fallback</done>
</task>

</tasks>

<verification>
1. Run `npm test src/lib/utils.test.ts` - all tests pass (original 7 cn tests + new ~16 date tests)
2. Run `npm test` - full test suite passes
3. Run `npm run test:coverage` - utils.ts shows improved coverage for safeParseISO and safeFormatDate
</verification>

<success_criteria>
- [ ] safeParseISO tests cover: valid ISO (3), invalid strings (3), null (1), undefined (1) = 8 tests
- [ ] safeFormatDate tests cover: valid formats (3), invalid input (3), custom fallback (2) = 8 tests
- [ ] All tests in utils.test.ts pass (7 + 16 = 23 total)
- [ ] No test pollution between describe blocks
- [ ] Coverage reports show safeParseISO and safeFormatDate functions tested
</success_criteria>

<output>
After completion, create `.planning/phases/04-utility-tests/04-01-SUMMARY.md`
</output>

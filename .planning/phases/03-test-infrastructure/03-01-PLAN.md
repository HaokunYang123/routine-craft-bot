---
phase: 03-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - src/test/setup.ts
  - tsconfig.test.json
autonomous: true

must_haves:
  truths:
    - "`npm test` executes Vitest and exits successfully"
    - "`npm run test:coverage` generates coverage report"
    - "`npm run test:watch` starts Vitest in watch mode"
    - "TypeScript recognizes Vitest globals (describe, it, expect) without errors"
  artifacts:
    - path: "src/test/setup.ts"
      provides: "Test setup with jest-dom matchers and browser API mocks"
      contains: "@testing-library/jest-dom/vitest"
    - path: "vite.config.ts"
      provides: "Vitest configuration"
      contains: "test:"
    - path: "tsconfig.test.json"
      provides: "TypeScript config for test files"
      contains: "vitest/globals"
  key_links:
    - from: "vite.config.ts"
      to: "src/test/setup.ts"
      via: "setupFiles array"
      pattern: "setupFiles.*setup\\.ts"
    - from: "package.json"
      to: "vitest"
      via: "npm scripts"
      pattern: '"test":\\s*"vitest'
---

<objective>
Configure Vitest test runner with React Testing Library for the project.

Purpose: Establish the testing foundation that all subsequent test phases depend on.
Output: Working `npm test`, `npm run test:coverage`, and `npm run test:watch` commands with TypeScript support.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-test-infrastructure/03-RESEARCH.md

Key context from research:
- Use Vitest with `globals: true`, `environment: 'jsdom'`
- Setup file extends expect with jest-dom matchers via `@testing-library/jest-dom/vitest`
- Mock browser APIs not available in jsdom: matchMedia, ResizeObserver, IntersectionObserver
- Mock next-themes useTheme hook globally (used by Sonner toaster)
- Create tsconfig.test.json extending tsconfig.app.json with vitest/globals types
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies and add npm scripts</name>
  <files>package.json</files>
  <action>
Install dev dependencies:
```bash
npm install -D vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event jsdom @vitest/coverage-v8
```

Add test scripts to package.json scripts section:
```json
"test": "vitest run",
"test:watch": "vitest",
"test:coverage": "vitest run --coverage"
```

Do NOT modify any existing scripts. Add these three new scripts.
  </action>
  <verify>Run `npm test` - should output "No test files found" (not an error about missing vitest)</verify>
  <done>Dependencies installed, scripts added, `npm test` recognizes vitest command</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vitest in vite.config.ts and create setup file</name>
  <files>vite.config.ts, src/test/setup.ts</files>
  <action>
Update vite.config.ts to add test configuration:
1. Add `/// <reference types="vitest/config" />` at the top
2. Add `test` block to the config object:
```typescript
test: {
  globals: true,
  environment: 'jsdom',
  setupFiles: ['./src/test/setup.ts'],
  include: ['src/**/*.{test,spec}.{ts,tsx}'],
  coverage: {
    provider: 'v8',
    reporter: ['text', 'json', 'html'],
    exclude: [
      'node_modules/',
      'src/test/',
      '**/*.d.ts',
      'src/main.tsx',
      'src/vite-env.d.ts',
    ],
  },
},
```

Create src/test/setup.ts:
```typescript
import '@testing-library/jest-dom/vitest';
import { cleanup } from '@testing-library/react';
import { afterEach, vi } from 'vitest';

// Cleanup after each test
afterEach(() => {
  cleanup();
});

// Mock next-themes globally (used by Sonner toaster)
vi.mock('next-themes', () => ({
  useTheme: () => ({
    theme: 'light',
    setTheme: vi.fn(),
    resolvedTheme: 'light',
    themes: ['light', 'dark', 'system'],
  }),
}));

// Mock matchMedia (not available in jsdom)
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation((query: string) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// Mock ResizeObserver (not available in jsdom)
global.ResizeObserver = vi.fn().mockImplementation(() => ({
  observe: vi.fn(),
  unobserve: vi.fn(),
  disconnect: vi.fn(),
}));

// Mock IntersectionObserver (not available in jsdom)
global.IntersectionObserver = vi.fn().mockImplementation(() => ({
  observe: vi.fn(),
  unobserve: vi.fn(),
  disconnect: vi.fn(),
}));
```

Create src/test/ directory if it doesn't exist.
  </action>
  <verify>Run `npm test` - should still say "No test files found" but not error on setup file</verify>
  <done>Vitest configured in vite.config.ts, setup.ts created with all browser API mocks</done>
</task>

<task type="auto">
  <name>Task 3: Create TypeScript config for tests</name>
  <files>tsconfig.test.json</files>
  <action>
Create tsconfig.test.json at project root:
```json
{
  "extends": "./tsconfig.app.json",
  "compilerOptions": {
    "types": ["vitest/globals", "@testing-library/jest-dom"]
  },
  "include": ["src/**/*.test.ts", "src/**/*.test.tsx", "src/test/**/*"]
}
```

This config:
- Extends the app config for consistent settings
- Adds vitest/globals types so describe/it/expect are recognized
- Adds jest-dom types so toBeInTheDocument() etc. are recognized
- Only includes test files and the test utilities directory

Note: tsconfig.json already has project references - this new file will be picked up by IDE/Vitest for test files. No need to modify tsconfig.json itself.
  </action>
  <verify>Open a .test.ts file in VS Code - no red squiggles on `describe`, `it`, `expect`</verify>
  <done>TypeScript recognizes test globals without compile errors</done>
</task>

</tasks>

<verification>
Run the following to verify the complete setup:
1. `npm test` - exits with "No test files found" (not error)
2. `npm run test:coverage` - exits with "No test files found" (not error)
3. `npm run test:watch` - starts watch mode (Ctrl+C to exit)
4. Create a trivial test file to confirm full pipeline works (removed after verification)
</verification>

<success_criteria>
- Dependencies installed: vitest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event, jsdom, @vitest/coverage-v8
- npm scripts added: test, test:watch, test:coverage
- vite.config.ts contains test configuration block
- src/test/setup.ts exists with jest-dom extension and browser API mocks
- tsconfig.test.json exists with vitest/globals types
- `npm test` command executes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-infrastructure/03-01-SUMMARY.md`
</output>

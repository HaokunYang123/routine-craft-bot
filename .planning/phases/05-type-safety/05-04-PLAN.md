---
phase: 05-type-safety
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/components/auth/MultiAuthLogin.tsx
  - src/components/student/JoinInstructor.tsx
  - tsconfig.app.json
autonomous: true
requirement: TYPE-04

must_haves:
  truths:
    - "All RPC function calls have typed responses"
    - "RPC parameter types match function signatures"
    - "TypeScript strict mode is enabled"
    - "tsc --noEmit passes with no errors"
  artifacts:
    - path: "tsconfig.app.json"
      provides: "TypeScript configuration"
      contains: '"strict": true'
    - path: "src/components/auth/MultiAuthLogin.tsx"
      provides: "Multi-auth login component"
      min_lines: 50
  key_links:
    - from: "src/components/auth/MultiAuthLogin.tsx"
      to: "src/integrations/supabase/types.ts"
      via: "Typed RPC calls"
      pattern: 'rpc\\("validate_qr_token"'
---

<objective>
Type RPC function calls and enable TypeScript strict mode for compile-time type safety.

Purpose: RPC functions are typed in the regenerated types.ts but the calling code needs proper type annotations for parameters and return values. Enabling strict mode ensures TypeScript catches all potential type errors, not just explicit ones.

Output: All RPC calls properly typed, TypeScript strict mode enabled, zero type errors.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-type-safety/05-01-SUMMARY.md
@.planning/phases/05-type-safety/05-02-SUMMARY.md
@.planning/phases/05-type-safety/05-03-SUMMARY.md
@src/integrations/supabase/types.ts
@src/components/auth/MultiAuthLogin.tsx
@src/components/student/JoinInstructor.tsx
@tsconfig.app.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix remaining RPC type casts in auth components</name>
  <files>src/components/auth/MultiAuthLogin.tsx, src/components/student/JoinInstructor.tsx</files>
  <action>
Remove `as any` casts from RPC calls in auth-related components.

**MultiAuthLogin.tsx (1 cast):**
- Line 88: `supabase.rpc("validate_qr_token" as any, {token})` -> `supabase.rpc("validate_qr_token", {token})`

After removing the cast, TypeScript should infer the return type from types.ts. If the RPC function returns a complex type, you may need to:
1. Check the Functions section in types.ts for the exact return type
2. Create a local interface if needed for complex returns:

```typescript
// If types.ts shows validate_qr_token returns Json, define expected shape:
interface QRTokenResult {
  session_id: string;
  session_name: string;
  coach_id: string;
}

// Then type the result:
const { data, error } = await supabase.rpc("validate_qr_token", { token });
const results = data as QRTokenResult[] | null;
```

**JoinInstructor.tsx (1 cast):**
- Line 30: `supabase.rpc("accept_invite" as any, {p_join_code})` -> `supabase.rpc("accept_invite", {p_join_code})`

Similarly, define the expected return shape if needed:
```typescript
interface InviteResult {
  success: boolean;
  message?: string;
  class_name?: string;
}
```

Note: The parameter name must match exactly what's in types.ts (e.g., `p_join_code` vs `join_code`).
  </action>
  <verify>
1. `grep -c "as any" src/components/auth/MultiAuthLogin.tsx` returns 0
2. `grep -c "as any" src/components/student/JoinInstructor.tsx` returns 0
3. `npx tsc --noEmit -p tsconfig.app.json 2>&1 | grep -E "MultiAuthLogin|JoinInstructor"` returns nothing
  </verify>
  <done>
All RPC function calls in auth components use proper types without casts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable TypeScript strict mode</name>
  <files>tsconfig.app.json</files>
  <action>
Enable TypeScript strict mode in tsconfig.app.json.

Update the linting section:
```json
{
  "compilerOptions": {
    // ... other options

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitAny": true,
    "noFallthroughCasesInSwitch": true
  }
}
```

After enabling strict mode, run `npx tsc --noEmit -p tsconfig.app.json` to check for errors.

**If errors appear:**
1. Count total errors: `npx tsc --noEmit -p tsconfig.app.json 2>&1 | grep -c "error TS"`
2. If < 10 errors: Fix them in this task
3. If > 10 errors: Document the count and most common error types

Common strict mode errors and fixes:
- "Parameter 'x' implicitly has 'any' type" -> Add explicit type annotation
- "Object is possibly 'null'" -> Add null check or optional chaining
- "'this' implicitly has type 'any'" -> Add explicit this parameter or use arrow function
- "Unused local variable" -> Remove or prefix with underscore

Focus on fixing errors in files modified in this phase first.
  </action>
  <verify>
1. `grep '"strict": true' tsconfig.app.json` confirms strict mode enabled
2. `npx tsc --noEmit -p tsconfig.app.json` exits with code 0 (no errors) OR document remaining error count
  </verify>
  <done>
tsconfig.app.json has strict mode enabled. Either tsc passes cleanly, or remaining errors are documented with count and file locations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Final type safety verification</name>
  <files>None (verification only)</files>
  <action>
Run comprehensive verification to confirm all type safety goals are met.

1. **Count remaining `as any` casts in src/:**
   ```bash
   grep -rn "as any" src/ --include="*.ts" --include="*.tsx" | grep -v node_modules | grep -v ".d.ts"
   ```
   Target: 0 casts (excluding type declaration files)

2. **Count remaining `as never` casts:**
   ```bash
   grep -rn "as never" src/ --include="*.ts" --include="*.tsx"
   ```
   Target: 0 casts

3. **Run TypeScript compiler:**
   ```bash
   npx tsc --noEmit -p tsconfig.app.json
   ```
   Target: Exit code 0

4. **Verify Supabase types are used:**
   ```bash
   grep -rn "from(\"" src/hooks/ src/pages/ src/components/ | grep -v "as any" | head -5
   ```
   Should show clean table name usage without casts

5. **Verify RPC calls are typed:**
   ```bash
   grep -rn "\.rpc(" src/ | grep -v "as any"
   ```
   Should show all RPC calls without casts

Document any exceptions or remaining issues for future work.
  </action>
  <verify>
All verification commands run and results documented.
  </verify>
  <done>
Phase 5 type safety requirements verified:
- TYPE-01: Supabase types regenerated
- TYPE-02: No `as any` in hooks
- TYPE-03: No `as any` in components
- TYPE-04: RPC functions typed, strict mode enabled
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Zero casts remaining:**
   ```bash
   grep -rn "as any\|as never" src/ --include="*.ts" --include="*.tsx" | grep -v ".d.ts" | wc -l
   # Should be 0
   ```

2. **TypeScript passes:**
   ```bash
   npx tsc --noEmit -p tsconfig.app.json
   echo $?
   # Should be 0
   ```

3. **Strict mode enabled:**
   ```bash
   grep -E '"strict"|"noImplicitAny"' tsconfig.app.json
   # Should show true for both
   ```

4. **Build succeeds:**
   ```bash
   npm run build
   # Should complete without type errors
   ```
</verification>

<success_criteria>
1. `grep -c "as any" src/components/auth/MultiAuthLogin.tsx` returns 0
2. `grep -c "as any" src/components/student/JoinInstructor.tsx` returns 0
3. tsconfig.app.json has `"strict": true`
4. `npx tsc --noEmit -p tsconfig.app.json` exits with code 0
5. `grep -rn "as any" src/ --include="*.ts" --include="*.tsx" | grep -v ".d.ts" | wc -l` returns 0
6. `npm run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-type-safety/05-04-SUMMARY.md`
</output>

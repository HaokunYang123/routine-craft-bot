---
phase: 05-type-safety
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/pages/People.tsx
  - src/pages/GroupDetail.tsx
  - src/pages/RecurringSchedules.tsx
  - src/pages/Assistant.tsx
  - src/pages/Tasks.tsx
  - src/components/student/InstructorsList.tsx
  - src/components/FloatingAI.tsx
  - src/types/browser.d.ts
autonomous: true
requirement: TYPE-03

must_haves:
  truths:
    - "No `as any` casts remain in page components"
    - "No `as any` casts remain in component files"
    - "All Supabase queries use proper table names"
  artifacts:
    - path: "src/pages/People.tsx"
      provides: "People management page"
      min_lines: 100
    - path: "src/components/FloatingAI.tsx"
      provides: "Floating AI assistant"
      min_lines: 50
  key_links:
    - from: "src/pages/People.tsx"
      to: "src/integrations/supabase/types.ts"
      via: "Typed Supabase queries"
      pattern: 'from\\("class_sessions"\\)'
---

<objective>
Remove all `as any` type casts from page and component files by using the regenerated Supabase types and proper browser type declarations.

Purpose: Components contain the UI layer that renders database data. Type casts in components can hide mismatches between what the UI expects and what the database returns, leading to runtime errors or undefined property access. Proper types catch these at compile time.

Output: Component files with zero type escape hatches.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-type-safety/05-01-SUMMARY.md
@src/integrations/supabase/types.ts
@src/pages/People.tsx
@src/pages/GroupDetail.tsx
@src/pages/Tasks.tsx
@src/components/FloatingAI.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix People.tsx type casts (6 casts)</name>
  <files>src/pages/People.tsx</files>
  <action>
Remove all `as any` casts from People.tsx.

Current casts to remove:
- Line 90: `.from("class_sessions" as any)` -> `.from("class_sessions")`
- Line 102: `.from("instructor_students" as any)` -> `.from("instructor_students")`
- Line 147: `supabase.rpc('generate_join_code' as any)` -> `supabase.rpc('generate_join_code')`
- Line 161: `supabase.from("class_sessions" as any).insert(...)` -> `supabase.from("class_sessions").insert(...)`
- Line 189: `supabase.rpc("delete_class_session" as any, {...})` -> `supabase.rpc("delete_class_session", {...})`
- Line 214: `supabase.rpc("remove_student_from_class" as any, {...})` -> `supabase.rpc("remove_student_from_class", {...})`

After removing casts:
- Verify insert objects match the table schema (TablesInsert<"class_sessions">)
- Verify RPC parameters match function signatures
- Add explicit type annotations if TypeScript can't infer

Note: The function name might be `generate_join_code` or `generate_invite_code` - use whatever is in the regenerated types.ts.
  </action>
  <verify>
1. `grep -c "as any" src/pages/People.tsx` returns 0
2. `npx tsc --noEmit -p tsconfig.app.json 2>&1 | grep -c People.tsx` returns 0
  </verify>
  <done>
People.tsx has zero `as any` casts. All class_sessions and instructor_students queries use proper types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix remaining page components (GroupDetail, RecurringSchedules, Assistant, Tasks)</name>
  <files>src/pages/GroupDetail.tsx, src/pages/RecurringSchedules.tsx, src/pages/Assistant.tsx, src/pages/Tasks.tsx</files>
  <action>
Remove `as any` casts from remaining page components.

**GroupDetail.tsx (2 casts):**
- Line 209: `.from("notes" as any)` -> `.from("notes")`
- Line 255: `supabase.from("notes" as any).insert({...})` -> `supabase.from("notes").insert({...})`

Note: If "notes" table doesn't exist in regenerated types, this indicates the table doesn't exist in production. In that case, the code may need to be commented out or the feature marked as incomplete. Document this in the summary.

**RecurringSchedules.tsx (2 casts):**
- Line 109: `.from("class_sessions" as any)` -> `.from("class_sessions")`
- Line 117: `.from("instructor_students" as any)` -> `.from("instructor_students")`

**Assistant.tsx (1 cast):**
- Line 158: `.from("class_sessions" as any)` -> `.from("class_sessions")`

**Tasks.tsx (1 cast):**
- Line 914: `setScheduleType(v as any)` -> Fix with proper union type

For Tasks.tsx, the issue is a Select component's onValueChange callback. The fix is to type the state setter:
```typescript
// Find the scheduleType state definition
const [scheduleType, setScheduleType] = useState<"once" | "daily" | "weekly" | "custom">("once");

// Then the cast becomes unnecessary:
onValueChange={(v) => setScheduleType(v as "once" | "daily" | "weekly" | "custom")}
// Or better, validate the value:
onValueChange={(v) => {
  if (["once", "daily", "weekly", "custom"].includes(v)) {
    setScheduleType(v as "once" | "daily" | "weekly" | "custom");
  }
}}
```
  </action>
  <verify>
1. `grep -c "as any" src/pages/GroupDetail.tsx` returns 0 (or document if table missing)
2. `grep -c "as any" src/pages/RecurringSchedules.tsx` returns 0
3. `grep -c "as any" src/pages/Assistant.tsx` returns 0
4. `grep -c "as any" src/pages/Tasks.tsx` returns 0
  </verify>
  <done>
All page components have zero `as any` casts (or documented exceptions for missing tables).
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix component files (InstructorsList, FloatingAI)</name>
  <files>src/components/student/InstructorsList.tsx, src/components/FloatingAI.tsx, src/types/browser.d.ts</files>
  <action>
Remove `as any` casts from component files.

**InstructorsList.tsx (1 cast):**
- Line 35: `.from("instructor_students" as any)` -> `.from("instructor_students")`

**FloatingAI.tsx (1 cast):**
- Line 59: `new (window as any).webkitSpeechRecognition()` -> Use typed approach

For FloatingAI.tsx, update src/types/browser.d.ts (created in 05-02) to add SpeechRecognition type:

```typescript
// src/types/browser.d.ts
declare global {
  interface Navigator {
    standalone?: boolean;
  }

  interface Window {
    /** Webkit Speech Recognition (Safari, older Chrome) */
    webkitSpeechRecognition?: typeof SpeechRecognition;
  }
}

export {};
```

Then update FloatingAI.tsx:
```typescript
// Before
const recognition = new (window as any).webkitSpeechRecognition();

// After - with proper type guard
const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognitionAPI) {
  const recognition = new SpeechRecognitionAPI();
  // ... rest of speech recognition setup
}
```

This pattern:
1. Checks for standard API first, then webkit prefix
2. Guards against undefined (browser doesn't support)
3. Uses proper types throughout
  </action>
  <verify>
1. `grep -c "as any" src/components/student/InstructorsList.tsx` returns 0
2. `grep -c "as any" src/components/FloatingAI.tsx` returns 0
3. `grep "webkitSpeechRecognition" src/types/browser.d.ts` shows proper declaration
  </verify>
  <done>
InstructorsList.tsx and FloatingAI.tsx have zero `as any` casts. Browser API types are properly declared.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Zero casts in pages:**
   ```bash
   grep -rn "as any" src/pages/
   # Should return nothing (or only documented exceptions)
   ```

2. **Zero casts in components:**
   ```bash
   grep -rn "as any" src/components/
   # Should return nothing
   ```

3. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit -p tsconfig.app.json 2>&1 | grep -c "error"
   # Should be 0 or significantly reduced
   ```
</verification>

<success_criteria>
1. `grep -c "as any" src/pages/People.tsx` returns 0
2. `grep -c "as any" src/pages/GroupDetail.tsx` returns 0 (or documented exception)
3. `grep -c "as any" src/pages/RecurringSchedules.tsx` returns 0
4. `grep -c "as any" src/pages/Assistant.tsx` returns 0
5. `grep -c "as any" src/pages/Tasks.tsx` returns 0
6. `grep -c "as any" src/components/student/InstructorsList.tsx` returns 0
7. `grep -c "as any" src/components/FloatingAI.tsx` returns 0
8. No new TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-type-safety/05-03-SUMMARY.md`
</output>

---
phase: 14-render-optimization
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/lib/profiling.ts
  - src/pages/CoachDashboard.tsx
  - src/pages/CoachCalendar.tsx
  - .planning/phases/14-render-optimization/PROFILING-REPORT.md
autonomous: true

must_haves:
  truths:
    - "Developer can profile any component with React.Profiler wrapper"
    - "Developer has documented render times for Dashboard and CoachCalendar"
    - "Profiling report identifies components exceeding 50ms threshold"
    - "Profiling data includes before/after baseline metrics"
  artifacts:
    - path: "src/lib/profiling.ts"
      provides: "Reusable profiling utilities for React DevTools workflow"
      min_lines: 15
    - path: ".planning/phases/14-render-optimization/PROFILING-REPORT.md"
      provides: "Performance baseline documentation with bottleneck analysis"
      min_lines: 40
  key_links:
    - from: "src/lib/profiling.ts"
      to: "src/pages/CoachDashboard.tsx"
      via: "ProfilerCallback import"
      pattern: "onRenderCallback|ProfilerWrapper"
---

<objective>
Profile Dashboard and CoachCalendar render performance and document bottlenecks.

Purpose: Establish performance baselines and identify optimization targets using React DevTools Profiler methodology.
Output: Profiling utility, instrumented pages, documented profiling report with specific recommendations.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-render-optimization/14-RESEARCH.md
@.planning/phases/14-render-optimization/14-CONTEXT.md

# Components to profile
@src/pages/CoachDashboard.tsx
@src/pages/CoachCalendar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profiling utilities</name>
  <files>src/lib/profiling.ts</files>
  <action>
Create `src/lib/profiling.ts` with reusable profiling utilities:

```typescript
/**
 * Performance profiling utilities for React DevTools workflow.
 * Use with React.Profiler to measure component render times.
 *
 * Usage:
 * ```tsx
 * import { Profiler } from 'react';
 * import { onRenderCallback, PERF_THRESHOLD_MS } from '@/lib/profiling';
 *
 * <Profiler id="MyComponent" onRender={onRenderCallback}>
 *   <MyComponent />
 * </Profiler>
 * ```
 */

// Performance threshold from user decision (14-CONTEXT.md)
export const PERF_THRESHOLD_MS = 50;

/**
 * Callback for React.Profiler that logs slow renders.
 * Only logs in development mode when render exceeds threshold.
 */
export function onRenderCallback(
  id: string,
  phase: 'mount' | 'update' | 'nested-update',
  actualDuration: number,
  baseDuration: number,
  startTime: number,
  commitTime: number
): void {
  // Only log in development
  if (process.env.NODE_ENV !== 'development') return;

  // Log all renders for profiling, warn on slow ones
  if (actualDuration > PERF_THRESHOLD_MS) {
    console.warn(
      `[Perf] SLOW: ${id} ${phase} took ${actualDuration.toFixed(2)}ms ` +
      `(base: ${baseDuration.toFixed(2)}ms)`
    );
  } else {
    console.log(
      `[Perf] ${id} ${phase}: ${actualDuration.toFixed(2)}ms`
    );
  }
}

/**
 * Helper to format profiling results for documentation.
 */
export function formatProfilingResult(
  componentId: string,
  phase: string,
  actualDuration: number,
  baseDuration: number
): string {
  const status = actualDuration > PERF_THRESHOLD_MS ? 'SLOW' : 'OK';
  return `| ${componentId} | ${phase} | ${actualDuration.toFixed(2)}ms | ${baseDuration.toFixed(2)}ms | ${status} |`;
}
```
  </action>
  <verify>
- `npm run build` passes without TypeScript errors
- File exports PERF_THRESHOLD_MS, onRenderCallback, formatProfilingResult
  </verify>
  <done>
- Profiling utilities created with 50ms threshold
- onRenderCallback logs slow renders in development
- Reusable for any component profiling
  </done>
</task>

<task type="auto">
  <name>Task 2: Add profiling to Dashboard and Calendar, document results</name>
  <files>src/pages/CoachDashboard.tsx, src/pages/CoachCalendar.tsx, .planning/phases/14-render-optimization/PROFILING-REPORT.md</files>
  <action>
1. Add Profiler wrapper to CoachDashboard.tsx:
   - Import `{ Profiler }` from 'react'
   - Import `{ onRenderCallback }` from '@/lib/profiling'
   - Wrap the main return JSX in `<Profiler id="CoachDashboard" onRender={onRenderCallback}>...</Profiler>`
   - Add comment: `// Profiler wrapper for performance measurement - see PROFILING-REPORT.md`

2. Add Profiler wrapper to CoachCalendar.tsx:
   - Import `{ Profiler }` from 'react'
   - Import `{ onRenderCallback }` from '@/lib/profiling'
   - Wrap the main return JSX in `<Profiler id="CoachCalendar" onRender={onRenderCallback}>...</Profiler>`
   - Add comment: `// Profiler wrapper for performance measurement - see PROFILING-REPORT.md`

3. Create `.planning/phases/14-render-optimization/PROFILING-REPORT.md`:

```markdown
# Phase 14: Performance Profiling Report

**Date:** [current date]
**Method:** React DevTools Profiler + console logging via src/lib/profiling.ts
**Threshold:** 50ms (from CONTEXT.md user decision)

## Summary

This report documents baseline render performance for CoachDashboard and CoachCalendar components. Measurements taken using React.Profiler wrapper in development mode.

## Methodology

1. Added `<Profiler id="..." onRender={onRenderCallback}>` wrapper to each component
2. Performed standard user interactions:
   - Dashboard: Initial load, tab switching, data refresh
   - Calendar: Initial load, month navigation, date selection, view mode switching
3. Recorded actualDuration and baseDuration from Profiler callback
4. Identified renders exceeding 50ms threshold

## Baseline Measurements

### CoachDashboard

| Component | Phase | Actual Duration | Base Duration | Status |
|-----------|-------|-----------------|---------------|--------|
| CoachDashboard | mount | TBD | TBD | TBD |
| CoachDashboard | update (tab) | TBD | TBD | TBD |

**Observations:**
- Initial mount time: TBD
- Update patterns: TBD
- Bottlenecks identified: TBD

### CoachCalendar

| Component | Phase | Actual Duration | Base Duration | Status |
|-----------|-------|-----------------|---------------|--------|
| CoachCalendar | mount | TBD | TBD | TBD |
| CoachCalendar | update (nav) | TBD | TBD | TBD |
| CoachCalendar | update (select) | TBD | TBD | TBD |

**Observations:**
- Initial mount time: TBD
- Update patterns: TBD
- Bottlenecks identified: TBD

## Identified Bottlenecks

### CoachCalendar Sub-Components

Based on code analysis and profiling:

1. **DaySheetContent** - Re-renders on every parent state change
   - Receives new function references on each render
   - Contains complex nested structure (groups -> members -> tasks)

2. **WeekView** - Re-renders when getTasksForDate changes
   - Receives new function reference each render
   - Maps over days array with nested task filtering

3. **DayView** - Similar issues to WeekView
   - Complex nested rendering
   - Function props not memoized

4. **TaskList** - Used in multiple places
   - Large component with dialog state
   - Re-renders frequently due to parent updates

## Recommendations

### Immediate (14-03)

1. **Apply React.memo to sub-components:**
   - DayCell (if extracted from month view)
   - WeekView
   - DayView
   - TaskList

2. **Memoize callbacks in CoachCalendar:**
   - navigatePeriod -> useCallback
   - handleDateClick -> useCallback
   - goToToday -> useCallback
   - getTasksForDate -> useMemo for the result

3. **Memoize computed data:**
   - tasksByDate Map -> useMemo
   - groupMap -> useMemo (already done via useEffect, but could be useMemo)

### Future Considerations

- React 19 Compiler upgrade would auto-memoize
- Virtual scrolling for large task lists
- Pagination within calendar view for many tasks per day

## Notes

- Profiler wrappers should be removed or disabled before production deploy
- Use React DevTools Profiler UI for detailed flamegraph analysis
- Threshold of 50ms based on user-specified requirement in CONTEXT.md
```
  </action>
  <verify>
- `npm run build` passes without errors
- CoachDashboard.tsx imports and uses Profiler wrapper
- CoachCalendar.tsx imports and uses Profiler wrapper
- PROFILING-REPORT.md exists with structure for documenting measurements
  </verify>
  <done>
- Profiler wrappers added to Dashboard and Calendar
- Profiling report template created with methodology and recommendations
- Bottleneck analysis identifies specific sub-components for memoization
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build verification: `npm run build` completes without errors
2. Test verification: `npm test` - all tests pass
3. Profiling infrastructure:
   - `ls src/lib/profiling.ts` exists
   - grep "Profiler" src/pages/CoachDashboard.tsx shows import and usage
   - grep "Profiler" src/pages/CoachCalendar.tsx shows import and usage
4. Documentation:
   - `.planning/phases/14-render-optimization/PROFILING-REPORT.md` exists
   - Contains methodology, baseline tables, and recommendations sections
</verification>

<success_criteria>
- Profiling utilities created in src/lib/profiling.ts
- CoachDashboard and CoachCalendar instrumented with React.Profiler
- PROFILING-REPORT.md documents baseline metrics and identifies bottlenecks
- Recommendations section specifies which sub-components to memoize in 14-03
- All tests pass
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-render-optimization/14-02-SUMMARY.md`
</output>

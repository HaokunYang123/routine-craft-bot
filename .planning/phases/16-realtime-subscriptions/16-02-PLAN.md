---
phase: 16-realtime-subscriptions
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/pages/CoachDashboard.tsx
  - src/pages/CoachCalendar.tsx
autonomous: true

must_haves:
  truths:
    - "Coach sees student task completions instantly without page refresh"
    - "Coach calendar updates when students complete tasks"
    - "No memory leaks after navigating away from coach pages"
  artifacts:
    - path: "src/pages/CoachDashboard.tsx"
      provides: "Realtime-enabled dashboard using useRealtimeSubscription"
      contains: "useRealtimeSubscription"
    - path: "src/pages/CoachCalendar.tsx"
      provides: "Realtime-enabled calendar using useRealtimeSubscription"
      contains: "useRealtimeSubscription"
  key_links:
    - from: "src/pages/CoachDashboard.tsx"
      to: "useRealtimeSubscription"
      via: "hook import"
      pattern: "import.*useRealtimeSubscription"
    - from: "src/pages/CoachDashboard.tsx"
      to: "queryKeys.assignments"
      via: "cache invalidation target"
      pattern: "queryKeys\\.assignments"
    - from: "src/pages/CoachCalendar.tsx"
      to: "useRealtimeSubscription"
      via: "hook import"
      pattern: "import.*useRealtimeSubscription"
---

<objective>
Integrate realtime subscriptions into coach views (Dashboard and Calendar) so coaches see student updates instantly.

Purpose: REAL-01 (task completion visible to coach instantly) and REAL-04 (updates via React Query cache)
Output: CoachDashboard and CoachCalendar components use the new useRealtimeSubscription hook with proper cleanup.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-realtime-subscriptions/16-CONTEXT.md
@.planning/phases/16-realtime-subscriptions/16-01-SUMMARY.md
@src/hooks/useRealtimeSubscription.ts
@src/hooks/useVisibilityRefetch.ts
@src/lib/realtime/channels.ts
@src/lib/queries/keys.ts
@src/pages/CoachDashboard.tsx
@src/pages/CoachCalendar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor CoachDashboard to use useRealtimeSubscription</name>
  <files>src/pages/CoachDashboard.tsx</files>
  <action>
Replace the existing manual realtime subscription (lines 82-107) with the new useRealtimeSubscription hook.

1. Add imports at top:
```typescript
import { useRealtimeSubscription } from '@/hooks/useRealtimeSubscription';
import { useVisibilityRefetch } from '@/hooks/useVisibilityRefetch';
import { REALTIME_CHANNELS } from '@/lib/realtime/channels';
import { queryKeys } from '@/lib/queries/keys';
```

2. Remove the existing useEffect block that creates the channel manually (lines 82-107):
```typescript
// DELETE THIS BLOCK:
// Real-time subscription for task completions
useEffect(() => {
  if (!user || groups.length === 0) return;
  const channel = supabase
    .channel('coach-dashboard-updates')
    ...
  return () => {
    supabase.removeChannel(channel);
  };
}, [user, groups]);
```

3. Add new hook calls after the existing hooks (around line 50-ish, after useAuth/useGroups/useAssignments):
```typescript
// Realtime subscription for task completions (REAL-01)
const assignmentQueryKeys = [queryKeys.assignments.all] as const;
useRealtimeSubscription({
  channelName: REALTIME_CHANNELS.COACH_TASK_UPDATES(user?.id || ''),
  table: 'task_instances',
  event: '*',
  queryKeysToInvalidate: assignmentQueryKeys,
  enabled: !!user && groups.length > 0,
});

// Refetch on tab visibility change (handles backgrounded tabs)
useVisibilityRefetch(assignmentQueryKeys);
```

Key changes:
- Use consistent channel naming from channels.ts
- Invalidate queryKeys.assignments.all (covers all assignment queries)
- enabled: !!user && groups.length > 0 (same condition as before)
- Add visibility refetch for robustness

4. Remove the direct `loadGroupStats()` call that was in the old realtime callback. The React Query invalidation will trigger refetch automatically.

5. Keep the manual `loadGroupStats` function - it's still used for initial load and will be triggered by React Query's refetch.
  </action>
  <verify>
1. File compiles: `npx tsc --noEmit src/pages/CoachDashboard.tsx`
2. No duplicate channel subscriptions (search for "coach-dashboard-updates" - should not exist)
3. Import statements present for new hooks
4. npm run build passes
  </verify>
  <done>CoachDashboard uses useRealtimeSubscription hook, old manual subscription removed, imports added for new realtime modules.</done>
</task>

<task type="auto">
  <name>Task 2: Add realtime subscription to CoachCalendar</name>
  <files>src/pages/CoachCalendar.tsx</files>
  <action>
Add realtime subscription to CoachCalendar so it updates when students complete tasks.

1. Add imports at top of file:
```typescript
import { useRealtimeSubscription } from '@/hooks/useRealtimeSubscription';
import { useVisibilityRefetch } from '@/hooks/useVisibilityRefetch';
import { REALTIME_CHANNELS } from '@/lib/realtime/channels';
import { queryKeys } from '@/lib/queries/keys';
```

2. Find where useAuth is called (should be near top of component). Add realtime hooks after useAuth:
```typescript
const { user } = useAuth();

// Realtime subscription for task completions (REAL-01: coach sees updates)
const assignmentQueryKeys = [queryKeys.assignments.all] as const;
useRealtimeSubscription({
  channelName: REALTIME_CHANNELS.COACH_TASK_UPDATES(user?.id || ''),
  table: 'task_instances',
  event: '*',
  queryKeysToInvalidate: assignmentQueryKeys,
  enabled: !!user,
});

// Refetch on tab visibility change
useVisibilityRefetch(assignmentQueryKeys);
```

Note: CoachCalendar needs same channel name as CoachDashboard - Supabase deduplicates channels with same name, so both components share one subscription when both are mounted. When user navigates, the hook's cleanup ensures no leaks.

Per CONTEXT.md: "Calendar view updates in realtime when tasks are completed"
  </action>
  <verify>
1. File compiles: `npx tsc --noEmit src/pages/CoachCalendar.tsx`
2. Imports present for useRealtimeSubscription, useVisibilityRefetch, REALTIME_CHANNELS, queryKeys
3. useRealtimeSubscription called with correct parameters
4. npm run build passes
  </verify>
  <done>CoachCalendar subscribes to task_instances changes and invalidates assignment queries on updates.</done>
</task>

</tasks>

<verification>
1. npm run build passes
2. npm test passes (no regressions)
3. Both coach pages compile without TypeScript errors
4. No references to old manual subscription pattern ('coach-dashboard-updates' channel name used inline)
</verification>

<success_criteria>
- CoachDashboard.tsx imports and uses useRealtimeSubscription
- CoachCalendar.tsx imports and uses useRealtimeSubscription
- Both use REALTIME_CHANNELS.COACH_TASK_UPDATES for channel naming
- Both use queryKeys.assignments.all for cache invalidation
- Both use useVisibilityRefetch for reconnection handling
- npm run build passes
- npm test passes
</success_criteria>

<output>
After completion, create `.planning/phases/16-realtime-subscriptions/16-02-SUMMARY.md`
</output>

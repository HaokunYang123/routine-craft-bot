---
phase: 16-realtime-subscriptions
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/pages/student/StudentHome.tsx
  - src/pages/student/StudentCalendar.tsx
autonomous: true

must_haves:
  truths:
    - "Student sees new assignments from coach instantly without page refresh"
    - "Student calendar updates when coach assigns new tasks"
    - "No memory leaks after navigating between student pages"
  artifacts:
    - path: "src/pages/student/StudentHome.tsx"
      provides: "Realtime-enabled student home with direct Supabase subscription"
      contains: "supabase.channel"
    - path: "src/pages/student/StudentCalendar.tsx"
      provides: "Realtime-enabled student calendar with direct Supabase subscription"
      contains: "supabase.channel"
  key_links:
    - from: "src/pages/student/StudentHome.tsx"
      to: "REALTIME_CHANNELS.STUDENT_ASSIGNMENTS"
      via: "channel name constant"
      pattern: "STUDENT_ASSIGNMENTS"
    - from: "src/pages/student/StudentCalendar.tsx"
      to: "REALTIME_CHANNELS.STUDENT_TASKS"
      via: "channel name constant"
      pattern: "STUDENT_TASKS"

# Architectural note: Student views use manual supabase.channel subscriptions
# (not useRealtimeSubscription hook) because they query Supabase directly
# instead of using React Query hooks. The hook invalidates React Query cache,
# which wouldn't trigger refetch for direct Supabase queries.
# Coach views use React Query (useAssignments), so they use the hook.
---

<objective>
Integrate realtime subscriptions into student views (Home and Calendar) so students see new assignments instantly.

Purpose: REAL-02 (new assignments from coach appear without refresh), REAL-06 (subscriptions filtered by user_id)
Output: StudentHome and StudentCalendar components have manual realtime subscriptions with user-specific filtering.

**Architectural note:** Student views use direct Supabase queries (not React Query hooks), so they use manual supabase.channel subscriptions that call their existing fetch functions. This differs from coach views which use the useRealtimeSubscription hook because they use React Query.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-realtime-subscriptions/16-CONTEXT.md
@.planning/phases/16-realtime-subscriptions/16-01-SUMMARY.md
@src/lib/realtime/channels.ts
@src/pages/student/StudentHome.tsx
@src/pages/student/StudentCalendar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add realtime subscription to StudentHome</name>
  <files>src/pages/student/StudentHome.tsx</files>
  <action>
Add realtime subscription so new assignments from coach appear instantly.

**Note:** StudentHome uses direct Supabase queries (not React Query), so we use a manual supabase.channel subscription that calls the existing fetchTasks() function.

1. Add import at top of file (after existing imports):
```typescript
import { REALTIME_CHANNELS } from '@/lib/realtime/channels';
```

2. Add realtime subscription useEffect after the existing useEffect that calls fetchTasks on mount (around line 84-89):
```typescript
// Realtime subscription - refetch on any task_instances changes for this user (REAL-02, REAL-06)
useEffect(() => {
  if (!user) return;

  const channel = supabase
    .channel(REALTIME_CHANNELS.STUDENT_ASSIGNMENTS(user.id))
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'task_instances',
        filter: `assignee_id=eq.${user.id}`,
      },
      (payload) => {
        console.log('[StudentHome] Realtime update:', payload.eventType);
        fetchTasks(); // Refetch on any change
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, [user]);
```

3. Add visibility refetch useEffect after the realtime subscription:
```typescript
// Refetch on tab visibility change (handles backgrounded tabs)
useEffect(() => {
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible' && user) {
      console.log('[StudentHome] Tab visible, refetching');
      fetchTasks();
      fetchConnectedGroups();
      fetchCoachNotes();
    }
  };

  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
  };
}, [user]);
```

Key points:
- Uses STUDENT_ASSIGNMENTS channel (different from coach channel)
- Filter: `assignee_id=eq.${user.id}` satisfies REAL-06 (user-specific filtering)
- Calls existing fetchTasks() directly (not React Query invalidation)
- Per CONTEXT.md: "New assignments appear in list silently (no toast)"
  </action>
  <verify>
1. File compiles: `npx tsc --noEmit src/pages/student/StudentHome.tsx`
2. Import for REALTIME_CHANNELS present
3. useEffect with supabase.channel and removeChannel cleanup present
4. Visibility change handler present
5. npm run build passes
  </verify>
  <done>StudentHome subscribes to task_instances changes filtered by assignee_id and refetches on realtime events.</done>
</task>

<task type="auto">
  <name>Task 2: Add realtime subscription to StudentCalendar</name>
  <files>src/pages/student/StudentCalendar.tsx</files>
  <action>
Add realtime subscription so student calendar updates when coach assigns new tasks.

**Note:** Like StudentHome, StudentCalendar uses direct Supabase queries, so we use manual supabase.channel subscription.

1. Add import at top of file:
```typescript
import { REALTIME_CHANNELS } from '@/lib/realtime/channels';
```

2. Add realtime subscription useEffect after the existing useEffect that fetches tasks (around line 53-80):
```typescript
// Realtime subscription for assignment updates (REAL-02, REAL-06)
useEffect(() => {
  if (!user) return;

  const channel = supabase
    .channel(REALTIME_CHANNELS.STUDENT_TASKS(user.id))
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'task_instances',
        filter: `assignee_id=eq.${user.id}`,
      },
      (payload) => {
        console.log('[StudentCalendar] Realtime update:', payload.eventType);
        fetchTasks(); // Refetch on any change
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, [user, currentMonth]); // Include currentMonth to resubscribe when month changes
```

3. Add visibility refetch useEffect after the realtime subscription:
```typescript
// Refetch on tab visibility change (handles backgrounded tabs)
useEffect(() => {
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible' && user) {
      console.log('[StudentCalendar] Tab visible, refetching');
      fetchTasks();
    }
  };

  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
  };
}, [user, currentMonth]);
```

Key points:
- Uses STUDENT_TASKS channel (allows separate channel from StudentHome if needed in future)
- Same filter pattern (assignee_id) for REAL-06
- Depends on [user, currentMonth] to resubscribe when user navigates to different month
  </action>
  <verify>
1. File compiles: `npx tsc --noEmit src/pages/student/StudentCalendar.tsx`
2. Import for REALTIME_CHANNELS present
3. useEffect with supabase.channel and removeChannel cleanup present
4. Visibility change handler present
5. npm run build passes
  </verify>
  <done>StudentCalendar subscribes to task_instances changes and refetches when coach assigns or modifies tasks.</done>
</task>

</tasks>

<verification>
1. npm run build passes
2. npm test passes (no regressions)
3. Both student pages compile without TypeScript errors
4. Both pages have proper cleanup (supabase.removeChannel in useEffect return)
5. Both pages have visibility change handlers
</verification>

<success_criteria>
- StudentHome.tsx has realtime subscription with assignee_id filter
- StudentCalendar.tsx has realtime subscription with assignee_id filter
- Both use REALTIME_CHANNELS constants for channel naming
- Both have visibility change handlers for reconnection
- Both have proper cleanup (removeChannel) in useEffect
- npm run build passes
- npm test passes
</success_criteria>

<output>
After completion, create `.planning/phases/16-realtime-subscriptions/16-03-SUMMARY.md`
</output>

---
phase: 16-realtime-subscriptions
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/pages/student/StudentHome.tsx
  - src/pages/student/StudentCalendar.tsx
autonomous: true

must_haves:
  truths:
    - "Student sees new assignments from coach instantly without page refresh"
    - "Student calendar updates when coach assigns new tasks"
    - "No memory leaks after navigating between student pages"
  artifacts:
    - path: "src/pages/student/StudentHome.tsx"
      provides: "Realtime-enabled student home using useRealtimeSubscription"
      contains: "useRealtimeSubscription"
    - path: "src/pages/student/StudentCalendar.tsx"
      provides: "Realtime-enabled student calendar using useRealtimeSubscription"
      contains: "useRealtimeSubscription"
  key_links:
    - from: "src/pages/student/StudentHome.tsx"
      to: "useRealtimeSubscription"
      via: "hook import"
      pattern: "import.*useRealtimeSubscription"
    - from: "src/pages/student/StudentHome.tsx"
      to: "REALTIME_CHANNELS.STUDENT_ASSIGNMENTS"
      via: "channel name"
      pattern: "STUDENT_ASSIGNMENTS"
    - from: "src/pages/student/StudentCalendar.tsx"
      to: "useRealtimeSubscription"
      via: "hook import"
      pattern: "import.*useRealtimeSubscription"
---

<objective>
Integrate realtime subscriptions into student views (Home and Calendar) so students see new assignments instantly.

Purpose: REAL-02 (new assignments from coach appear without refresh), REAL-06 (subscriptions filtered by user_id)
Output: StudentHome and StudentCalendar components use useRealtimeSubscription hook with user-specific filtering.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-realtime-subscriptions/16-CONTEXT.md
@.planning/phases/16-realtime-subscriptions/16-01-SUMMARY.md
@src/hooks/useRealtimeSubscription.ts
@src/hooks/useVisibilityRefetch.ts
@src/lib/realtime/channels.ts
@src/lib/queries/keys.ts
@src/pages/student/StudentHome.tsx
@src/pages/student/StudentCalendar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add realtime subscription to StudentHome</name>
  <files>src/pages/student/StudentHome.tsx</files>
  <action>
Add realtime subscription so new assignments from coach appear instantly.

1. Add imports at top of file (after existing imports):
```typescript
import { useRealtimeSubscription } from '@/hooks/useRealtimeSubscription';
import { useVisibilityRefetch } from '@/hooks/useVisibilityRefetch';
import { REALTIME_CHANNELS } from '@/lib/realtime/channels';
import { queryKeys } from '@/lib/queries/keys';
```

2. After the useAuth hook call (around line 57), add realtime hooks:
```typescript
const { user } = useAuth();

// Realtime subscription for new assignments (REAL-02: new assignments appear instantly)
// Filter by assignee_id for REAL-06 (user-specific subscription)
const assignmentQueryKeys = [queryKeys.assignments.all] as const;
useRealtimeSubscription({
  channelName: REALTIME_CHANNELS.STUDENT_ASSIGNMENTS(user?.id || ''),
  table: 'task_instances',
  filter: user?.id ? `assignee_id=eq.${user.id}` : undefined,
  event: '*',
  queryKeysToInvalidate: assignmentQueryKeys,
  enabled: !!user,
});

// Refetch on tab visibility change
useVisibilityRefetch(assignmentQueryKeys);
```

Key points:
- Use STUDENT_ASSIGNMENTS channel (different from coach channel)
- Add filter: `assignee_id=eq.${user.id}` for REAL-06 (user-specific filtering)
- Per CONTEXT.md: "New assignments appear in list silently (no toast)"

3. The existing fetchTasks() call will be triggered by React Query's refetch when cache is invalidated.

Note: StudentHome currently uses local state (setTasks) instead of React Query. The realtime subscription will still work because it invalidates queryKeys.assignments.all, which will trigger any component using useAssignments to refetch. If StudentHome directly queries Supabase (not via React Query), the invalidation won't help that component. However, the fetchTasks function in the useEffect will run on mount. Consider adding a manual refetch or migrating to React Query in a future phase if needed.

For now, add a simple listener that calls fetchTasks when realtime events occur:

Actually, reviewing the code - StudentHome fetches directly from Supabase, not via React Query hook. We need to trigger a manual refetch. Let's add a different approach:

Instead of invalidating React Query cache (which StudentHome doesn't use), we'll add a simple realtime subscription that calls fetchTasks directly:

```typescript
// Realtime subscription - refetch on any task_instances changes for this user
useEffect(() => {
  if (!user) return;

  const channel = supabase
    .channel(REALTIME_CHANNELS.STUDENT_ASSIGNMENTS(user.id))
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'task_instances',
        filter: `assignee_id=eq.${user.id}`,
      },
      (payload) => {
        console.log('[StudentHome] Realtime update:', payload.eventType);
        fetchTasks(); // Refetch on any change
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, [user]);
```

This is simpler for StudentHome since it doesn't use React Query. Add this after the existing useEffect that calls fetchTasks on mount (around line 84-89). Import REALTIME_CHANNELS at the top.

Also add visibility refetch:
```typescript
// Refetch on tab visibility change
useEffect(() => {
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible' && user) {
      console.log('[StudentHome] Tab visible, refetching');
      fetchTasks();
      fetchConnectedGroups();
      fetchCoachNotes();
    }
  };

  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
  };
}, [user]);
```
  </action>
  <verify>
1. File compiles: `npx tsc --noEmit src/pages/student/StudentHome.tsx`
2. Import for REALTIME_CHANNELS present
3. useEffect with supabase.channel and removeChannel cleanup present
4. npm run build passes
  </verify>
  <done>StudentHome subscribes to task_instances changes filtered by assignee_id and refetches on realtime events.</done>
</task>

<task type="auto">
  <name>Task 2: Add realtime subscription to StudentCalendar</name>
  <files>src/pages/student/StudentCalendar.tsx</files>
  <action>
Add realtime subscription so student calendar updates when coach assigns new tasks.

1. Add import at top of file:
```typescript
import { REALTIME_CHANNELS } from '@/lib/realtime/channels';
```

2. After the existing useEffect that fetches tasks (around line 53-80), add realtime subscription:
```typescript
// Realtime subscription for assignment updates (REAL-02)
useEffect(() => {
  if (!user) return;

  const channel = supabase
    .channel(REALTIME_CHANNELS.STUDENT_TASKS(user.id))
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'task_instances',
        filter: `assignee_id=eq.${user.id}`,
      },
      (payload) => {
        console.log('[StudentCalendar] Realtime update:', payload.eventType);
        fetchTasks(); // Refetch on any change
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, [user, currentMonth]); // Include currentMonth to resubscribe when month changes
```

3. Add visibility refetch after the realtime subscription:
```typescript
// Refetch on tab visibility change
useEffect(() => {
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible' && user) {
      console.log('[StudentCalendar] Tab visible, refetching');
      fetchTasks();
    }
  };

  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
  };
}, [user, currentMonth]);
```

Note: StudentCalendar uses STUDENT_TASKS channel (different from STUDENT_ASSIGNMENTS) because it may need different filtering in the future. The filter is the same (assignee_id) but channel names allow separation.
  </action>
  <verify>
1. File compiles: `npx tsc --noEmit src/pages/student/StudentCalendar.tsx`
2. Import for REALTIME_CHANNELS present
3. useEffect with supabase.channel and removeChannel cleanup present
4. npm run build passes
  </verify>
  <done>StudentCalendar subscribes to task_instances changes and refetches when coach assigns or modifies tasks.</done>
</task>

</tasks>

<verification>
1. npm run build passes
2. npm test passes (no regressions)
3. Both student pages compile without TypeScript errors
4. Both pages have proper cleanup (supabase.removeChannel in useEffect return)
</verification>

<success_criteria>
- StudentHome.tsx has realtime subscription with assignee_id filter
- StudentCalendar.tsx has realtime subscription with assignee_id filter
- Both use REALTIME_CHANNELS constants for channel naming
- Both have visibility change handlers for reconnection
- Both have proper cleanup (removeChannel) in useEffect
- npm run build passes
- npm test passes
</success_criteria>

<output>
After completion, create `.planning/phases/16-realtime-subscriptions/16-03-SUMMARY.md`
</output>

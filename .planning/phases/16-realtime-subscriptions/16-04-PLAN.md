---
phase: 16-realtime-subscriptions
plan: 04
type: execute
wave: 3
depends_on: ["16-02", "16-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Task completion by student is visible to coach instantly"
    - "New assignment by coach appears for student instantly"
    - "Browser memory stable after 10+ page navigations"
    - "React Query DevTools shows cache invalidations on realtime events"
  artifacts: []
  key_links: []
---

<objective>
Verify end-to-end realtime synchronization works between coach and student views.

Purpose: Confirm REAL-01 through REAL-06 requirements are met in a real multi-user scenario.
Output: Phase verification complete, ready for STATE.md update.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-realtime-subscriptions/16-CONTEXT.md
@.planning/phases/16-realtime-subscriptions/16-02-SUMMARY.md
@.planning/phases/16-realtime-subscriptions/16-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete realtime synchronization infrastructure:
- useRealtimeSubscription hook for Supabase postgres_changes
- useVisibilityRefetch hook for tab backgrounding
- REALTIME_CHANNELS constants for channel naming
- CoachDashboard and CoachCalendar with realtime subscriptions
- StudentHome and StudentCalendar with realtime subscriptions
  </what-built>
  <how-to-verify>
**Setup (requires two browser windows/tabs):**
1. Start dev server: `npm run dev`
2. Open two browser windows side by side
3. In Window 1: Log in as a Coach account
4. In Window 2: Log in as a Student account (member of coach's group)
5. Open React Query DevTools in both windows (click the floating icon bottom-right)

**Test REAL-01: Student task completion visible to coach**
1. In Student window: Navigate to Home or Calendar
2. In Coach window: Navigate to Dashboard, observe student's task count
3. In Student window: Mark a task as complete (check the checkbox)
4. In Coach window: Verify the completion count updates within 2-3 seconds (no page refresh)
5. Verify: React Query DevTools shows "assignments" query refetching

**Test REAL-02: New assignment appears for student**
1. In Coach window: Navigate to a group, create a new task assignment for today
2. In Student window: Observe Home page task list
3. Verify: New task appears within 2-3 seconds (no page refresh needed)

**Test REAL-03: Memory leak check**
1. In either window: Open browser DevTools > Performance > Memory
2. Take heap snapshot (baseline)
3. Navigate between pages 10+ times (Dashboard -> Calendar -> Home -> back, etc.)
4. Take another heap snapshot
5. Verify: Memory growth is < 10MB (some growth is normal from React, but no runaway growth)
6. Verify: Console shows "[Realtime] Disconnected" when navigating away (cleanup working)

**Test REAL-04: React Query cache integration**
1. Open React Query DevTools
2. Perform any realtime action (student completes task)
3. Verify: DevTools shows "assignments" query state change to "fetching" then "fresh"
4. Verify: No duplicate network requests for same data

**Test REAL-05: Optimistic update + realtime confirmation**
1. In Student window: Check a task as complete
2. Observe: Checkbox fills immediately (optimistic)
3. Observe: React Query DevTools shows mutation then query refetch
4. Verify: UI doesn't flicker or revert (realtime confirms optimistic update)

**Test REAL-06: User-specific filtering**
1. Log in as a different student (not in coach's group)
2. Have the first student complete a task
3. Verify: Second student does NOT see any realtime updates for first student's tasks
4. Verify: Console shows channel subscription with user-specific filter

**Test tab backgrounding:**
1. Complete a task in Student window
2. Background the Coach window (switch to different app) for 30 seconds
3. Return to Coach window
4. Verify: Console shows "[Visibility] Tab visible, refetching queries"
5. Verify: Data is current (any updates during background are shown)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe which tests failed and what behavior was observed.</resume-signal>
</task>

</tasks>

<verification>
All REAL-01 through REAL-06 requirements verified by human testing:
- REAL-01: Task completion visible to coach instantly
- REAL-02: New assignments appear for student without refresh
- REAL-03: No memory leaks after navigation
- REAL-04: Updates flow through React Query cache
- REAL-05: Optimistic updates confirmed by realtime
- REAL-06: Subscriptions filtered by user_id
</verification>

<success_criteria>
- All 6 test scenarios pass
- No console errors related to realtime subscriptions
- Memory remains stable after repeated navigation
- React Query DevTools shows proper cache invalidation
</success_criteria>

<output>
After completion, create `.planning/phases/16-realtime-subscriptions/16-04-SUMMARY.md`
</output>

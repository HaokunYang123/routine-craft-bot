---
phase: 12-mutations-optimistic-updates
plan: 04
type: execute
wave: 3
depends_on: ["12-01", "12-02", "12-03"]
files_modified:
  - src/pages/student/StudentHome.tsx
  - src/pages/student/StudentCalendar.tsx
  - src/pages/student/StudentTasks.tsx
autonomous: true

must_haves:
  truths:
    - "User sees task checkbox update instantly when clicking in StudentHome"
    - "User sees task checkbox update instantly when clicking in StudentCalendar"
    - "User sees checkbox revert with error toast if task completion fails"
    - "User does not see manual refresh required after task completion"
  artifacts:
    - path: "src/pages/student/StudentHome.tsx"
      provides: "Component using React Query optimistic mutation"
      contains: "updateTaskStatus"
    - path: "src/pages/student/StudentCalendar.tsx"
      provides: "Component using React Query optimistic mutation"
      contains: "updateTaskStatus"
  key_links:
    - from: "src/pages/student/StudentHome.tsx"
      to: "src/hooks/useAssignments.ts"
      via: "useAssignments hook"
      pattern: "useAssignments.*updateTaskStatus"
---

<objective>
Update student components to use React Query mutations instead of manual optimistic state.

Purpose: The hooks now have optimistic mutations. Components need to use them instead of the manual setTasks pattern they currently implement. This consolidates optimistic update logic in hooks and removes duplication.

Output:
- StudentHome.tsx uses useAssignments updateTaskStatus mutation
- StudentCalendar.tsx uses useAssignments updateTaskStatus mutation
- StudentTasks.tsx updated to use mutation pattern
- Manual setTasks optimistic updates removed
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-mutations-optimistic-updates/12-CONTEXT.md

@src/pages/student/StudentHome.tsx
@src/pages/student/StudentCalendar.tsx
@src/pages/student/StudentTasks.tsx
@src/hooks/useAssignments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update StudentHome to use hook mutation</name>
  <files>src/pages/student/StudentHome.tsx</files>
  <action>
Replace the manual optimistic update pattern in StudentHome with useAssignments mutation:

1. Import useAssignments (if not already):
```typescript
import { useAssignments } from "@/hooks/useAssignments";
```

2. Get mutation from hook:
```typescript
const { updateTaskStatus, isUpdatingTask } = useAssignments();
```

3. Replace the existing toggleTaskStatus function (~lines 378-420):
```typescript
// OLD: Manual optimistic update with setTasks
const toggleTaskStatus = async (taskId: string, completed: boolean) => {
  try {
    // Optimistic update
    setTasks((prev) => prev.map((t) => ...));
    await supabase.from("task_instances").update(...);
    if (completed) toast({ title: "Nice work!" });
  } catch {
    // Revert
    setTasks((prev) => prev.map((t) => ...));
    toast({ title: "Error", variant: "destructive" });
  }
};

// NEW: Use hook's optimistic mutation
const toggleTaskStatus = async (taskId: string, completed: boolean) => {
  // The hook handles optimistic update, rollback, and error toast
  // We only pass context for cache key matching
  await updateTaskStatus(
    taskId,
    completed ? "completed" : "pending",
    undefined, // note
    user?.id,  // assigneeId for cache key
    format(new Date(), "yyyy-MM-dd") // date for cache key
  );
};
```

4. Remove the manual toast on success - the hook doesn't show toast for task completion (per CONTEXT.md).

5. If the component uses local `tasks` state that gets updated via setTasks, consider:
   - Option A: Keep local state but sync with React Query cache via useQuery
   - Option B: Fetch tasks through useQuery directly (cleaner)

   For this migration, keep the existing data fetching pattern but remove the manual optimistic update. The hook mutation will update the React Query cache, and subsequent fetches will get the updated data.

Note: The component may still use local state for tasks. The optimistic update happens in React Query cache. When the component re-renders or refetches, it will get the updated data.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
Test manually: open StudentHome, click a task checkbox - should update instantly.
  </verify>
  <done>
StudentHome uses useAssignments updateTaskStatus mutation, manual optimistic code removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update StudentCalendar to use hook mutation</name>
  <files>src/pages/student/StudentCalendar.tsx</files>
  <action>
Apply same pattern to StudentCalendar:

1. Import useAssignments:
```typescript
import { useAssignments } from "@/hooks/useAssignments";
```

2. Get mutation from hook:
```typescript
const { updateTaskStatus } = useAssignments();
```

3. Replace toggleTaskStatus function (around line 82):
```typescript
// OLD pattern (manual optimistic update with setTasks)
const toggleTaskStatus = async (taskId: string, completed: boolean) => {
  try {
    setTasks((prev) => prev.map((t) => ...));
    await supabase.from("task_instances").update(...);
    toast({ title: "Task completed!" });
  } catch {
    setTasks((prev) => prev.map((t) => ...));
    toast({ title: "Error", variant: "destructive" });
  }
};

// NEW: Use hook mutation
const toggleTaskStatus = async (taskId: string, completed: boolean) => {
  await updateTaskStatus(
    taskId,
    completed ? "completed" : "pending",
    undefined,
    user?.id,
    selectedDate ? format(selectedDate, "yyyy-MM-dd") : undefined
  );
};
```

4. Remove direct supabase import if only used for this mutation.

5. Remove the success toast call - per CONTEXT.md, task completion doesn't show toast.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
Test manually: open StudentCalendar, click a task checkbox - should update instantly.
  </verify>
  <done>
StudentCalendar uses useAssignments updateTaskStatus mutation, manual optimistic code removed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update StudentTasks to use hook mutation</name>
  <files>src/pages/student/StudentTasks.tsx</files>
  <action>
Apply same pattern to StudentTasks:

1. Import useAssignments if not present:
```typescript
import { useAssignments } from "@/hooks/useAssignments";
```

2. Get mutation from hook:
```typescript
const { updateTaskStatus } = useAssignments();
```

3. Replace the toggleTask function (around line 47):
```typescript
// OLD: Direct supabase call
const toggleTask = async (task: Task) => {
  await supabase
    .from("tasks")
    .update({
      completed: !task.completed,
      completed_at: !task.completed ? new Date().toISOString() : null,
    })
    .eq("id", task.id);
  fetchTasks();
};

// NEW: Use hook mutation
const toggleTask = async (task: Task) => {
  const newStatus = task.completed ? "pending" : "completed";
  await updateTaskStatus(task.id, newStatus, undefined, user?.id);
  // Note: The hook invalidates cache, so fetchTasks() might still be needed
  // if this component isn't using React Query for its data
  fetchTasks(); // Keep if component uses local state for tasks
};
```

Note: StudentTasks.tsx uses a different "tasks" table, not "task_instances". Check if updateTaskStatus works for this or if it needs a separate mutation. If "tasks" is a different entity, keep the existing pattern and just ensure it has proper error handling.

If StudentTasks uses a legacy "tasks" table that's different from task_instances:
- Keep the existing toggleTask implementation
- Add proper try/catch with error toast
- This is out of scope for this plan (different entity)
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
If StudentTasks uses different table, verify the existing pattern still works.
  </verify>
  <done>
StudentTasks updated to use consistent mutation pattern (or documented why it differs).
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should compile without errors
2. Manual testing in dev server:
   - StudentHome: Click task checkbox -> instant update, no spinner
   - StudentCalendar: Click task checkbox -> instant update, no spinner
   - Error case: Mock network failure -> checkbox reverts with error toast
</verification>

<success_criteria>
- StudentHome uses useAssignments updateTaskStatus (no manual setTasks optimistic update)
- StudentCalendar uses useAssignments updateTaskStatus (no manual setTasks optimistic update)
- StudentTasks uses consistent pattern (or documented exception)
- All components compile without TypeScript errors
- Checkbox click updates instantly across all student pages
</success_criteria>

<output>
After completion, create `.planning/phases/12-mutations-optimistic-updates/12-04-SUMMARY.md`
</output>

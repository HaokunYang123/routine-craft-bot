---
phase: 12-mutations-optimistic-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-toast.ts
  - src/components/ui/toaster.tsx
  - src/hooks/useGroups.ts
  - src/hooks/useGroups.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'Saving...' button state when creating/updating/deleting a group"
    - "User sees confirmation toast after group mutation succeeds"
    - "User sees error toast that stays visible longer (5s) when mutation fails"
    - "Success toasts auto-dismiss in 3 seconds"
  artifacts:
    - path: "src/hooks/use-toast.ts"
      provides: "Toast duration support"
      contains: "duration"
    - path: "src/hooks/useGroups.ts"
      provides: "useMutation hooks for groups"
      contains: "useMutation"
  key_links:
    - from: "src/hooks/useGroups.ts"
      to: "@tanstack/react-query"
      via: "useMutation import"
      pattern: "useMutation"
---

<objective>
Add useMutation pattern to useGroups hook and configure toast duration support.

Purpose: Establish the mutation pattern with loading states (isPending) and toast duration for feedback. useGroups is the first hook to migrate because it has the most mutations (5) and is commonly used.

Output:
- useGroups with useMutation for createGroup, updateGroup, deleteGroup, addMember, removeMember
- Toast hook supports duration prop (3s success, 5s error)
- Backward-compatible interface (existing component code works unchanged)
- New properties exposed: isCreating, isUpdating, isDeleting, etc.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/hooks/useGroups.ts
@src/hooks/use-toast.ts
@src/components/ui/toaster.tsx
@src/lib/queries/keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add toast duration support</name>
  <files>src/hooks/use-toast.ts, src/components/ui/toaster.tsx</files>
  <action>
Update the toast system to support per-toast duration:

1. In `src/hooks/use-toast.ts`:
   - Add `duration?: number` to the Toast type
   - Update the `toast()` function to accept duration
   - Modify TOAST_REMOVE_DELAY logic: if toast has duration, use that instead of default
   - Default durations: 3000ms for success (default variant), 5000ms for destructive variant
   - Update `addToRemoveQueue` to use toast-specific duration

2. In `src/components/ui/toaster.tsx`:
   - Pass the duration prop from ToasterToast to the Toast component
   - Radix Toast.Root accepts `duration` prop natively

Implementation detail: When toast is created, calculate and store the duration based on variant if not explicitly provided. The Radix ToastPrimitive.Root component accepts a `duration` prop that controls auto-dismiss.
  </action>
  <verify>
Create a simple test file that imports toast and calls it with different variants:
```typescript
toast({ title: "Success", description: "3 second toast" }); // Should dismiss in 3s
toast({ title: "Error", description: "5 second toast", variant: "destructive" }); // Should dismiss in 5s
toast({ title: "Custom", description: "Custom duration", duration: 10000 }); // Should dismiss in 10s
```
Run `npm run build` to verify TypeScript compiles correctly.
  </verify>
  <done>
Toast hook accepts duration prop, defaults to 3s for success and 5s for destructive variant.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate useGroups mutations to useMutation</name>
  <files>src/hooks/useGroups.ts</files>
  <action>
Migrate all 5 mutation functions in useGroups to useMutation pattern:

1. Add `useMutation` import from '@tanstack/react-query'

2. Replace `createGroup` async function with useMutation:
```typescript
const createGroupMutation = useMutation({
  mutationFn: async (data: { name: string; color: string; icon?: string }) => {
    // Move existing createGroup logic here
    // Return the created group data
  },
  onSuccess: async (data) => {
    toast({ title: "Group Created", description: `"${data.name}" has been created` });
    return queryClient.invalidateQueries({ queryKey: queryKeys.groups.list(user!.id) });
  },
  onError: (error) => {
    const message = error && typeof error === 'object' && 'message' in error
      ? (error as { message: string }).message
      : "Couldn't save changes. Please try again.";
    toast({ title: "Error", description: message, variant: "destructive" });
  },
});
```

3. Repeat for updateGroup, deleteGroup, addMember, removeMember with same pattern.

4. Update return object to expose both backward-compatible functions and new state:
```typescript
return {
  // ... existing properties
  // Backward-compatible wrappers
  createGroup: (name: string, color: string, icon?: string) =>
    createGroupMutation.mutateAsync({ name, color, icon: icon || "users" }),
  // NEW: Loading states for UI
  isCreating: createGroupMutation.isPending,
  isUpdating: updateGroupMutation.isPending,
  isDeleting: deleteGroupMutation.isPending,
  isAddingMember: addMemberMutation.isPending,
  isRemovingMember: removeMemberMutation.isPending,
};
```

5. Remove toast calls from inside try/catch blocks - they're now in onSuccess/onError.

6. Remove handleError calls from mutations - use onError callback instead.

Key pattern: Use `mutateAsync` for backward compatibility (returns Promise), but expose `isPending` for new loading UI.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles correctly.
Run `npm test -- --run useGroups` to verify existing tests pass.
  </verify>
  <done>
All 5 group mutations use useMutation pattern with isPending states exposed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update useGroups tests for useMutation</name>
  <files>src/hooks/useGroups.test.tsx</files>
  <action>
Update the existing useGroups tests to verify useMutation behavior:

1. Add tests for loading states:
```typescript
it('exposes isCreating state during group creation', async () => {
  // Arrange: Setup delayed mutation
  // Act: Trigger createGroup
  // Assert: isCreating is true during mutation, false after
});
```

2. Update existing mutation tests to verify:
   - Toast is called with correct message on success
   - Toast is called with destructive variant on error
   - Cache is invalidated after successful mutation

3. Add tests for the new isPending properties:
   - `isCreating` is true while createGroup mutation is in flight
   - `isUpdating` is true while updateGroup mutation is in flight
   - `isDeleting` is true while deleteGroup mutation is in flight

4. Ensure backward compatibility: existing tests that call `createGroup()` directly should still pass.

Key: The mutation functions still return Promises (via mutateAsync), so existing test patterns work.
  </action>
  <verify>
Run `npm test -- --run useGroups` - all tests should pass including new ones.
  </verify>
  <done>
useGroups tests verify useMutation loading states and toast behavior.
  </done>
</task>

</tasks>

<verification>
1. Run full test suite: `npm test -- --run`
2. Run TypeScript check: `npm run build`
3. Verify toast duration by manual testing in dev server:
   - Success toast dismisses in ~3 seconds
   - Error toast dismisses in ~5 seconds
</verification>

<success_criteria>
- useGroups hook uses useMutation for all 5 mutations
- Toast hook supports duration prop with sensible defaults
- isCreating, isUpdating, isDeleting states are exposed
- All existing tests pass (backward compatibility maintained)
- New tests verify loading state behavior
</success_criteria>

<output>
After completion, create `.planning/phases/12-mutations-optimistic-updates/12-01-SUMMARY.md`
</output>

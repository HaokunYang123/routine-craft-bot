---
phase: 12-mutations-optimistic-updates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useTemplates.ts
  - src/hooks/useTemplates.test.tsx
  - src/hooks/useProfile.ts
  - src/hooks/useProfile.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees loading state when creating/updating/deleting a template"
    - "User sees confirmation toast after template mutation succeeds"
    - "User sees loading state when updating profile"
    - "User sees confirmation toast after profile update succeeds"
  artifacts:
    - path: "src/hooks/useTemplates.ts"
      provides: "useMutation hooks for templates"
      contains: "useMutation"
    - path: "src/hooks/useProfile.ts"
      provides: "useMutation hook for profile update"
      contains: "useMutation"
  key_links:
    - from: "src/hooks/useTemplates.ts"
      to: "@tanstack/react-query"
      via: "useMutation import"
      pattern: "useMutation"
    - from: "src/hooks/useProfile.ts"
      to: "@tanstack/react-query"
      via: "useMutation import"
      pattern: "useMutation"
---

<objective>
Migrate useTemplates and useProfile mutations to useMutation pattern.

Purpose: Apply the established useMutation pattern to remaining simple hooks. These can run in parallel with Plan 01 since they don't share files.

Output:
- useTemplates with useMutation for createTemplate, updateTemplate, deleteTemplate
- useProfile with useMutation for updateProfile
- Loading states exposed: isCreating, isUpdating, isDeleting for templates; isUpdating for profile
- Tests updated to verify mutation states
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/hooks/useTemplates.ts
@src/hooks/useProfile.ts
@src/lib/queries/keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate useTemplates mutations to useMutation</name>
  <files>src/hooks/useTemplates.ts, src/hooks/useTemplates.test.tsx</files>
  <action>
Migrate all 3 mutation functions in useTemplates to useMutation pattern:

1. Add `useMutation` import from '@tanstack/react-query'

2. Replace `createTemplate` async function:
```typescript
const createTemplateMutation = useMutation({
  mutationFn: async (data: { name: string; description: string; tasks: TemplateTask[] }) => {
    // Move existing createTemplate logic here
    // Return the created template
  },
  onSuccess: async (data) => {
    toast({
      title: "Template Created",
      description: `"${data.name}" has been saved with ${data.tasks?.length || 0} tasks.`,
    });
    return queryClient.invalidateQueries({ queryKey: queryKeys.templates.list(user!.id) });
  },
  onError: (error) => {
    handleError(error, { component: 'useTemplates', action: 'create template' });
  },
});
```

3. Repeat for updateTemplate and deleteTemplate.

4. Update return object:
```typescript
return {
  // ... existing properties
  // Backward-compatible wrappers
  createTemplate: (name: string, description: string, tasks: TemplateTask[]) =>
    createTemplateMutation.mutateAsync({ name, description, tasks }),
  updateTemplate: (templateId: string, name: string, description: string, tasks: TemplateTask[]) =>
    updateTemplateMutation.mutateAsync({ templateId, name, description, tasks }),
  deleteTemplate: (templateId: string) =>
    deleteTemplateMutation.mutateAsync({ templateId }),
  // NEW: Loading states
  isCreating: createTemplateMutation.isPending,
  isUpdating: updateTemplateMutation.isPending,
  isDeleting: deleteTemplateMutation.isPending,
};
```

5. Update tests to verify loading states and backward compatibility.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
Run `npm test -- --run useTemplates` to verify tests pass.
  </verify>
  <done>
useTemplates uses useMutation for all 3 mutations with isPending states exposed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate useProfile mutation to useMutation</name>
  <files>src/hooks/useProfile.ts, src/hooks/useProfile.test.tsx</files>
  <action>
Migrate updateProfile to useMutation pattern:

1. Add `useMutation` import from '@tanstack/react-query'

2. Replace `updateProfile` async function:
```typescript
const updateProfileMutation = useMutation({
  mutationFn: async (updates: Partial<Pick<Profile, "display_name" | "avatar_url">>) => {
    const { error } = await supabase
      .from("profiles")
      .update({
        ...updates,
        updated_at: new Date().toISOString(),
      })
      .eq("user_id", user!.id);

    if (error) throw error;
    return updates;
  },
  onSuccess: async () => {
    toast({
      title: "Profile Updated",
      description: "Your changes have been saved.",
    });
    return queryClient.invalidateQueries({ queryKey: queryKeys.profile.current(user!.id) });
  },
  onError: (error) => {
    handleError(error, { component: 'useProfile', action: 'update profile' });
  },
});
```

3. Update return object:
```typescript
return {
  // ... existing properties
  updateProfile: (updates: Partial<Pick<Profile, "display_name" | "avatar_url">>) =>
    updateProfileMutation.mutateAsync(updates).then(() => true).catch(() => false),
  isUpdating: updateProfileMutation.isPending,
};
```

Note: The wrapper maintains backward compatibility by returning boolean (true on success, false on error).

4. Update tests to verify loading state.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
Run `npm test -- --run useProfile` to verify tests pass.
  </verify>
  <done>
useProfile uses useMutation for updateProfile with isUpdating state exposed.
  </done>
</task>

</tasks>

<verification>
1. Run full test suite: `npm test -- --run`
2. Run TypeScript check: `npm run build`
3. Verify backward compatibility: existing tests that call mutation functions should pass unchanged
</verification>

<success_criteria>
- useTemplates uses useMutation for all 3 mutations
- useProfile uses useMutation for updateProfile
- Loading states exposed (isCreating, isUpdating, isDeleting)
- All existing tests pass
- New tests verify mutation loading states
</success_criteria>

<output>
After completion, create `.planning/phases/12-mutations-optimistic-updates/12-02-SUMMARY.md`
</output>

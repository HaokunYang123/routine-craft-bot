---
phase: 09-react-query-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/queries/keys.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Data stays cached for 5 minutes (staleTime configured)"
    - "Background refetch happens on window focus"
    - "Auth errors (401/403) do not retry automatically"
    - "Error toast appears exactly once per query error"
    - "All 103 existing tests pass unchanged"
  artifacts:
    - path: "src/lib/queries/keys.ts"
      provides: "Query key factory with hierarchical keys"
      exports: ["queryKeys"]
      contains: "groups.all"
    - path: "src/App.tsx"
      provides: "Production-ready QueryClient configuration"
      contains: "staleTime"
      contains: "gcTime"
      contains: "QueryCache"
  key_links:
    - from: "src/App.tsx"
      to: "src/lib/error.ts"
      via: "queryCache.onError calls handleError"
      pattern: "handleError.*component.*query"
    - from: "src/lib/queries/keys.ts"
      to: "future hook migrations"
      via: "exported queryKeys constant"
      pattern: "queryKeys\\.(groups|templates|assignments)"
---

<objective>
Establish React Query foundation with production-ready QueryClient configuration and query key factory.

Purpose: Prepare infrastructure for hook migrations in Phases 10-12 without changing any existing functionality. This phase addresses requirements RQ-01 (caching), RQ-04 (background refetch), and RQ-05 (deduplication preparation).

Output:
- Query key factory (`src/lib/queries/keys.ts`) with hierarchical keys for all entities
- Enhanced QueryClient in App.tsx with staleTime, gcTime, retry logic, and global error handling
- Verification that all existing tests pass unchanged
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/REACT_QUERY_ARCHITECTURE.md
@.planning/research/PITFALLS.md
@src/App.tsx
@src/lib/error.ts
@src/test/test-utils.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Query Key Factory</name>
  <files>src/lib/queries/keys.ts</files>
  <action>
Create the query key factory at `src/lib/queries/keys.ts` with hierarchical keys for all entities identified in research:

```typescript
export const queryKeys = {
  // Groups
  groups: {
    all: ['groups'] as const,
    lists: () => [...queryKeys.groups.all, 'list'] as const,
    list: (userId: string) => [...queryKeys.groups.lists(), userId] as const,
    details: () => [...queryKeys.groups.all, 'detail'] as const,
    detail: (groupId: string) => [...queryKeys.groups.details(), groupId] as const,
    members: (groupId: string) => [...queryKeys.groups.all, 'members', groupId] as const,
  },
  // Templates
  templates: {
    all: ['templates'] as const,
    lists: () => [...queryKeys.templates.all, 'list'] as const,
    list: (userId: string) => [...queryKeys.templates.lists(), userId] as const,
    details: () => [...queryKeys.templates.all, 'detail'] as const,
    detail: (templateId: string) => [...queryKeys.templates.details(), templateId] as const,
  },
  // Assignments
  assignments: {
    all: ['assignments'] as const,
    lists: () => [...queryKeys.assignments.all, 'list'] as const,
    list: (filters: { userId?: string; groupId?: string }) =>
      [...queryKeys.assignments.lists(), filters] as const,
    instances: (filters: { assigneeId?: string; date?: string; startDate?: string }) =>
      [...queryKeys.assignments.all, 'instances', filters] as const,
    progress: (groupId: string, date: string) =>
      [...queryKeys.assignments.all, 'progress', groupId, date] as const,
  },
  // Profile
  profile: {
    all: ['profile'] as const,
    current: (userId: string) => [...queryKeys.profile.all, userId] as const,
  },
  // Stickers
  stickers: {
    all: ['stickers'] as const,
    byUser: (userId: string) => [...queryKeys.stickers.all, userId] as const,
  },
  // Recurring Schedules
  recurringSchedules: {
    all: ['recurringSchedules'] as const,
    lists: () => [...queryKeys.recurringSchedules.all, 'list'] as const,
    list: (userId: string) => [...queryKeys.recurringSchedules.lists(), userId] as const,
  },
} as const;
```

Key design decisions:
- Hierarchical structure enables targeted invalidation (e.g., `queryKeys.groups.all` invalidates all group queries)
- `as const` assertions preserve literal types for type safety
- Consistent pattern: `all` -> `lists()` -> `list(id)` for each entity
- Includes all 6 hooks identified for migration (groups, templates, assignments, profile, stickers, recurringSchedules)

Create the directory `src/lib/queries/` if it doesn't exist.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
File exists and exports queryKeys:
```bash
grep -l "export const queryKeys" src/lib/queries/keys.ts
```
  </verify>
  <done>
- `src/lib/queries/keys.ts` exists with queryKeys export
- Contains hierarchical keys for: groups, templates, assignments, profile, stickers, recurringSchedules
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance QueryClient Configuration</name>
  <files>src/App.tsx</files>
  <action>
Enhance the existing QueryClient in `src/App.tsx` with production-ready defaults.

Current code (line 32):
```typescript
const queryClient = new QueryClient();
```

Replace with:
```typescript
import { QueryClient, QueryClientProvider, QueryCache } from "@tanstack/react-query";
import { handleError } from "@/lib/error";

const queryClient = new QueryClient({
  queryCache: new QueryCache({
    onError: (error, query) => {
      // Global error handler - prevents duplicate toasts when multiple components
      // use the same failing query (see PITFALLS.md M2)
      handleError(error, {
        component: String(query.queryKey[0]),
        action: 'fetch',
        // Don't show retry in global handler - let individual components decide
        silent: false,
      });
    },
  }),
  defaultOptions: {
    queries: {
      // Data freshness: consider data fresh for 5 minutes
      staleTime: 5 * 60 * 1000,
      // Cache garbage collection: keep unused data for 30 minutes
      gcTime: 30 * 60 * 1000,
      // Refetch behavior
      refetchOnWindowFocus: true,
      refetchOnReconnect: true,
      // Retry logic: don't retry auth errors
      retry: (failureCount, error) => {
        // Don't retry on auth errors (401, 403)
        if (error instanceof Error) {
          const msg = error.message.toLowerCase();
          if (
            msg.includes('401') ||
            msg.includes('403') ||
            msg.includes('unauthorized') ||
            msg.includes('forbidden')
          ) {
            return false;
          }
        }
        // Retry other errors up to 2 times
        return failureCount < 2;
      },
    },
    mutations: {
      // Mutations don't need global error handler - handled per-mutation
      // (prevents double toasts when mutation has its own onError)
    },
  },
});
```

Key configuration decisions (from REACT_QUERY_ARCHITECTURE.md):
- `staleTime: 5 * 60 * 1000` (5 min) - satisfies RQ-01 caching requirement
- `gcTime: 30 * 60 * 1000` (30 min) - reasonable memory/freshness tradeoff
- `refetchOnWindowFocus: true` - satisfies RQ-04 background refetch
- `retry` function - skips retry for 401/403 (auth errors shouldn't retry)
- `queryCache.onError` - centralized error handling prevents M2 duplicate toast pitfall

Update imports at top of file:
- Change `{ QueryClient, QueryClientProvider }` to `{ QueryClient, QueryClientProvider, QueryCache }`
- Add `import { handleError } from "@/lib/error";`
  </action>
  <verify>
1. App compiles without errors:
```bash
npx tsc --noEmit
```

2. App starts without runtime errors:
```bash
npm run dev &
sleep 5
curl -s http://localhost:5173 | head -20
kill %1
```

3. QueryCache import is present:
```bash
grep "QueryCache" src/App.tsx
```

4. staleTime is configured:
```bash
grep "staleTime" src/App.tsx
```
  </verify>
  <done>
- App.tsx imports QueryCache and handleError
- QueryClient has staleTime (5 min), gcTime (30 min), refetchOnWindowFocus (true)
- Retry function skips 401/403 errors
- queryCache.onError calls handleError for centralized error handling
- App compiles and starts without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Existing Tests Pass</name>
  <files></files>
  <action>
Run the complete test suite to verify no regressions.

The test suite (103 tests from v1) should pass unchanged because:
1. Query key factory is a new file, not used by existing code yet
2. QueryClient config changes are defaults only, not affecting test mocks
3. test-utils.tsx already creates fresh QueryClient per test with `gcTime: 0`

Run:
```bash
npm test
```

Expected: All tests pass.

If any tests fail, investigate and fix ONLY if the failure is due to the changes made in this plan (unlikely). The goal is zero regressions.
  </action>
  <verify>
```bash
npm test
```
Output should show all tests passing (103 tests from v1 milestone).
  </verify>
  <done>
- All existing tests pass without modification
- No regressions introduced by QueryClient configuration changes
- Test suite confirms backward compatibility
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify Phase 9 success criteria:

1. **QueryClient has production-ready defaults:**
   ```bash
   grep -E "staleTime|gcTime|refetchOnWindowFocus" src/App.tsx
   ```

2. **Query key factory exists:**
   ```bash
   ls -la src/lib/queries/keys.ts
   grep "queryKeys" src/lib/queries/keys.ts | head -5
   ```

3. **Global error handler configured:**
   ```bash
   grep "queryCache.*onError" src/App.tsx
   grep "handleError" src/App.tsx
   ```

4. **Tests pass:**
   ```bash
   npm test
   ```
</verification>

<success_criteria>
- [ ] `src/lib/queries/keys.ts` exists with hierarchical queryKeys for all 6 entities
- [ ] `src/App.tsx` QueryClient has staleTime (5min), gcTime (30min), retry logic
- [ ] `src/App.tsx` has queryCache.onError calling handleError
- [ ] All 103 existing tests pass unchanged
- [ ] TypeScript compiles without errors
- [ ] App runs without runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-react-query-foundation/09-01-SUMMARY.md`
</output>

---
phase: 07-hook-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useGroups.test.ts
autonomous: true

must_haves:
  truths:
    - "createGroup creates group with join code"
    - "updateGroup updates group and shows toast"
    - "deleteGroup removes group and updates state"
    - "addMember adds member to group"
    - "removeMember removes member from group"
    - "getGroupMembers returns members with display names"
    - "fetchGroups loads groups with member counts"
  artifacts:
    - path: "src/hooks/useGroups.test.ts"
      provides: "useGroups hook test suite"
      min_lines: 120
      contains: "describe('useGroups'"
  key_links:
    - from: "src/hooks/useGroups.test.ts"
      to: "src/hooks/useGroups.ts"
      via: "import { useGroups }"
      pattern: "import.*useGroups.*from"
    - from: "src/hooks/useGroups.test.ts"
      to: "src/hooks/useAuth"
      via: "vi.mock"
      pattern: "vi\\.mock\\('./useAuth'"
---

<objective>
Comprehensive test coverage for useGroups hook covering group management and member operations

Purpose: Verify useGroups correctly handles group CRUD operations (create, read, update, delete) and member management (add, remove, list with display names).

Output: `src/hooks/useGroups.test.ts` with tests for group and member operations
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hook-tests/07-RESEARCH.md

@src/hooks/useGroups.ts
@src/hooks/useAuth.tsx
@src/test/mocks/supabase.ts
@src/test/test-utils.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useGroups test file with group CRUD tests</name>
  <files>src/hooks/useGroups.test.ts</files>
  <action>
Create test suite for useGroups group operations:

1. Test file setup:
   - Import renderHook, waitFor, act from @testing-library/react
   - Import MemoryRouter for wrapper
   - Mock @/integrations/supabase/client using mockSupabaseModule
   - Mock ./useAuth to return authenticated user
   - Mock ./use-toast to capture toast calls
   - Create wrapper function with MemoryRouter and QueryClientProvider

2. Mock useAuth:
```typescript
vi.mock('./useAuth', () => ({
  useAuth: vi.fn(() => ({
    user: { id: 'coach-1', email: 'coach@test.com' },
    session: { access_token: 'mock-token' },
    loading: false,
    signOut: vi.fn(),
    sessionExpired: false,
    clearSessionExpired: vi.fn(),
  })),
}));
```

3. Mock useToast:
```typescript
const mockToast = vi.fn();
vi.mock('./use-toast', () => ({
  useToast: () => ({ toast: mockToast }),
}));
```

4. Test describe blocks:

   describe('fetchGroups'):
   - Test: loads groups with member counts on mount
   - Mock groups.select to return 2 groups
   - Mock group_members count query
   - Assert: result.current.groups has length 2 with member_count populated

   - Test: sets loading to false after fetch
   - Assert: loading starts true, becomes false after waitFor

   describe('createGroup'):
   - Test: creates group with join code
   - Mock supabase.rpc('generate_group_join_code') to return 'ABC123'
   - Mock groups.insert to return new group
   - Call createGroup('Test Group', 'blue', 'users')
   - Assert: returns created group, toast shows "Group Created"

   - Test: handles error gracefully
   - Mock supabase to return error
   - Assert: returns null, error handled via handleError

   describe('updateGroup'):
   - Test: updates group and shows toast
   - Mock groups.update().eq()
   - Call updateGroup(groupId, { name: 'Updated Name' })
   - Assert: returns true, toast shows "Group Updated"

   describe('deleteGroup'):
   - Test: removes group and updates state
   - Mock groups.delete().eq()
   - Populate initial groups state
   - Call deleteGroup(groupId)
   - Assert: returns true, group removed from result.current.groups

5. beforeEach cleanup:
   - resetMockSupabase()
   - mockToast.mockClear()
  </action>
  <verify>npm run test -- src/hooks/useGroups.test.ts --run</verify>
  <done>
    - Group CRUD tests pass: fetchGroups, createGroup, updateGroup, deleteGroup
    - Loading state transitions verified
    - Toast calls verified
    - Error handling verified
  </done>
</task>

<task type="auto">
  <name>Task 2: Add member management tests</name>
  <files>src/hooks/useGroups.test.ts</files>
  <action>
Add tests for member operations:

1. describe('addMember'):
   - Test: adds member to group
   - Mock group_members.insert
   - Call addMember('group-1', 'user-1')
   - Assert: returns true, toast shows "Member Added"

   - Test: handles duplicate member error
   - Mock supabase to return unique constraint error
   - Assert: returns false, error toast shown

2. describe('removeMember'):
   - Test: removes member from group
   - Mock group_members.delete().eq().eq() (two eq calls for group_id and user_id)
   - Call removeMember('group-1', 'user-1')
   - Assert: returns true, toast shows "Member Removed"

3. describe('getGroupMembers'):
   - Test: returns members with display names
   - Mock group_members.select to return 2 members
   - Mock profiles.select to return display_name and email
   - Call getGroupMembers('group-1')
   - Assert: returns members with display_name populated

   - Test: falls back to email prefix when no display_name
   - Mock profile with email but no display_name
   - Assert: display_name is email prefix (before @)

   - Test: returns empty array for group with no members
   - Mock group_members.select to return empty array
   - Assert: returns []

4. Mock pattern for chained eq calls:
```typescript
getMockSupabase().queryBuilder.eq.mockReturnValue(getMockSupabase().queryBuilder);
```

5. Verify fetchGroups is called after member operations to refresh counts
  </action>
  <verify>npm run test -- src/hooks/useGroups.test.ts --run</verify>
  <done>
    - Member tests pass: addMember, removeMember, getGroupMembers
    - Display name fallback logic verified
    - Error handling verified for duplicate member
    - Full HOOK-03 requirement satisfied
  </done>
</task>

</tasks>

<verification>
- All useGroups tests pass: `npm run test -- src/hooks/useGroups.test.ts --run`
- No console warnings about missing act() wrappers
- Group CRUD operations tested
- Member management operations tested
</verification>

<success_criteria>
- HOOK-03 requirement satisfied: useGroups has tests for group management and member operations
- createGroup tested with join code generation
- updateGroup and deleteGroup tested
- addMember and removeMember tested
- getGroupMembers tested with display name fallback logic
- fetchGroups tested with member count aggregation
</success_criteria>

<output>
After completion, create `.planning/phases/07-hook-tests/07-03-SUMMARY.md`
</output>

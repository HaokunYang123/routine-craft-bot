---
phase: 07-hook-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useAIAssistant.test.ts
autonomous: true

must_haves:
  truths:
    - "generatePlan returns success with AI-generated plan"
    - "Request times out after MAX_RETRIES exceeded"
    - "Retries on transient errors with exponential backoff"
    - "Does not retry auth errors (401)"
    - "Does not retry rate limit errors (429)"
    - "cancel() aborts pending request"
    - "Cleanup aborts request on unmount"
  artifacts:
    - path: "src/hooks/useAIAssistant.test.ts"
      provides: "useAIAssistant hook test suite"
      min_lines: 150
      contains: "describe('useAIAssistant'"
  key_links:
    - from: "src/hooks/useAIAssistant.test.ts"
      to: "src/hooks/useAIAssistant.ts"
      via: "import { useAIAssistant }"
      pattern: "import.*useAIAssistant.*from"
    - from: "src/hooks/useAIAssistant.test.ts"
      to: "vi.useFakeTimers"
      via: "timer mocking"
      pattern: "vi\\.useFakeTimers"
---

<objective>
Comprehensive test coverage for useAIAssistant hook covering timeout handling and retry behavior

Purpose: Verify useAIAssistant correctly handles timeouts, implements exponential backoff retry for transient errors, and properly distinguishes retryable from non-retryable errors.

Output: `src/hooks/useAIAssistant.test.ts` with tests for timeout, retry, and error handling
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hook-tests/07-RESEARCH.md

@src/hooks/useAIAssistant.ts
@src/hooks/useAuth.tsx
@src/test/mocks/supabase.ts
@src/test/test-utils.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAIAssistant test file with success and timeout tests</name>
  <files>src/hooks/useAIAssistant.test.ts</files>
  <action>
Create test suite for useAIAssistant focusing on success path and timeout handling:

1. Test file setup:
   - Import renderHook, waitFor, act from @testing-library/react
   - Mock @/integrations/supabase/client using mockSupabaseModule
   - Mock ./useAuth to return authenticated user
   - Use vi.useFakeTimers() in beforeEach for timeout testing
   - Use vi.useRealTimers() in afterEach

2. Mock useAuth:
```typescript
vi.mock('./useAuth', () => ({
  useAuth: vi.fn(() => ({
    user: { id: 'user-1', email: 'test@test.com' },
    loading: false,
  })),
}));
```

3. Add functions mock to Supabase client:
```typescript
beforeEach(() => {
  vi.useFakeTimers();
  resetMockSupabase();
  const mock = getMockSupabase();
  mock.client.functions = {
    invoke: vi.fn(),
  };
});
```

4. Test describe blocks:

   describe('success cases'):
   - Test: generatePlan returns success with AI-generated plan
   - Mock functions.invoke to resolve with { data: { result: { name: 'Plan', tasks: [] } } }
   - Call result.current.generatePlan('make a 2 week plan')
   - Assert: response.success === true, response.data defined

   - Test: sets loading during request
   - Assert: loading true during request, false after

   describe('timeout handling'):
   - Test: returns timeout error after MAX_RETRIES exceeded
   - Mock functions.invoke to always reject with AbortError
   - Start generatePlan, advance timers through all retry delays
   - Assert: response.success === false, error contains "timed out"

   Retry delay pattern (from useAIAssistant.ts): 1000ms, 2000ms, 4000ms
   ```typescript
   await act(async () => {
     await vi.advanceTimersByTimeAsync(1000); // First retry
     await vi.advanceTimersByTimeAsync(2000); // Second retry
     await vi.advanceTimersByTimeAsync(4000); // Third retry (exhausted)
   });
   ```

5. Important: Use vi.advanceTimersByTimeAsync (not vi.advanceTimersByTime) for async code
   - See 07-RESEARCH.md "Pitfall 4: Fake Timers with Async Code"
  </action>
  <verify>npm run test -- src/hooks/useAIAssistant.test.ts --run</verify>
  <done>
    - Success test passes with mocked AI response
    - Timeout test passes after advancing through retry delays
    - Loading state verified during requests
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry behavior tests</name>
  <files>src/hooks/useAIAssistant.test.ts</files>
  <action>
Add tests for retry logic with exponential backoff:

1. describe('retry behavior'):

   - Test: succeeds after retry on transient error
   - Mock functions.invoke:
     * First call: rejects with AbortError (timeout)
     * Second call: resolves with success
   - Start generatePlan, advance timer by 1000ms (first retry delay)
   - Assert: response.success === true, invoke called 2 times

   - Test: retries on 5xx server errors
   - Mock functions.invoke to return { error: { message: 'Internal error', status: 500 } }
   - Advance through retry delays
   - Assert: invoke called 3 times

2. describe('non-retryable errors'):

   - Test: does not retry auth errors (401)
   - Mock functions.invoke to return { data: null, error: { message: 'Unauthorized', status: 401 } }
   - Assert: invoke called only 1 time (no retry)
   - Assert: response.error contains "Session expired"

   - Test: does not retry rate limit errors (429)
   - Mock functions.invoke to return { error: { message: 'Rate limited', status: 429 } }
   - Assert: invoke called only 1 time
   - Assert: response.error contains "Too many requests"

   - Test: does not retry 4xx client errors
   - Mock functions.invoke to return { error: { message: 'Bad request', status: 400 } }
   - Assert: invoke called only 1 time

3. Test pattern for counting invocations:
```typescript
const mock = getMockSupabase();
// After test
expect(mock.client.functions.invoke).toHaveBeenCalledTimes(expectedCount);
```
  </action>
  <verify>npm run test -- src/hooks/useAIAssistant.test.ts --run</verify>
  <done>
    - Retry tests pass: transient errors retry, non-retryable errors fail immediately
    - Auth (401) errors do not retry
    - Rate limit (429) errors do not retry
    - Server (5xx) errors retry with backoff
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cancellation and cleanup tests</name>
  <files>src/hooks/useAIAssistant.test.ts</files>
  <action>
Add tests for cancellation and unmount cleanup:

1. describe('cancellation'):

   - Test: cancel() aborts pending request
   - Mock functions.invoke to never resolve (pending promise)
   - Start generatePlan, call result.current.cancel()
   - Assert: response.error === 'Request cancelled'
   - Assert: loading becomes false

   - Test: returns cancelled on abort during retry wait
   - Start request, after first failure advance timer partially
   - Call cancel() during retry delay
   - Assert: response indicates cancellation

2. describe('cleanup'):

   - Test: aborts request on unmount
   - Mock functions.invoke to never resolve
   - Start generatePlan, then call unmount()
   - Assert: no memory leaks, request aborted

3. Pattern for testing cancellation:
```typescript
it('cancel() aborts pending request', async () => {
  getMockSupabase().client.functions.invoke.mockImplementation(
    () => new Promise(() => {}) // Never resolves
  );

  const { result } = renderHook(() => useAIAssistant());

  let response: unknown;
  act(() => {
    result.current.generatePlan('test').then(r => { response = r; });
  });

  // Cancel while pending
  act(() => {
    result.current.cancel();
  });

  await waitFor(() => {
    expect(response).toBeDefined();
  });

  expect((response as { error: string }).error).toBe('Request cancelled');
  expect(result.current.loading).toBe(false);
});
```

4. Verify AbortController cleanup in useEffect runs on unmount
  </action>
  <verify>npm run test -- src/hooks/useAIAssistant.test.ts --run</verify>
  <done>
    - Cancel test passes: cancel() aborts and returns 'Request cancelled'
    - Cleanup test passes: unmount aborts pending requests
    - Loading state correctly reset on cancel/unmount
    - Full HOOK-04 requirement satisfied
  </done>
</task>

</tasks>

<verification>
- All useAIAssistant tests pass: `npm run test -- src/hooks/useAIAssistant.test.ts --run`
- No console warnings about missing act() wrappers
- Fake timers work correctly with async code
- Timeout, retry, and cancellation logic verified
</verification>

<success_criteria>
- HOOK-04 requirement satisfied: useAIAssistant has tests for timeout handling and error states
- Timeout after MAX_RETRIES tested
- Retry behavior tested (transient errors retry, auth/rate-limit do not)
- Exponential backoff delays verified (1s, 2s, 4s)
- cancel() and unmount cleanup tested
- Error message parsing verified for user-friendly messages
</success_criteria>

<output>
After completion, create `.planning/phases/07-hook-tests/07-04-SUMMARY.md`
</output>

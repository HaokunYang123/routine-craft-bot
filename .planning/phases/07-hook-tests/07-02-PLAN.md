---
phase: 07-hook-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useAssignments.test.ts
autonomous: true

must_haves:
  truths:
    - "createAssignment creates assignment and task instances"
    - "getTaskInstances returns filtered task instances"
    - "updateTaskStatus updates task status and shows toast"
    - "schedule_type 'once' creates single task on start_date"
    - "schedule_type 'daily' creates tasks for each day in range"
    - "schedule_type 'weekly' creates tasks on same day of week"
    - "schedule_type 'custom' creates tasks only on specified days"
  artifacts:
    - path: "src/hooks/useAssignments.test.ts"
      provides: "useAssignments hook test suite"
      min_lines: 150
      contains: "describe('useAssignments'"
  key_links:
    - from: "src/hooks/useAssignments.test.ts"
      to: "src/hooks/useAssignments.ts"
      via: "import { useAssignments }"
      pattern: "import.*useAssignments.*from"
    - from: "src/hooks/useAssignments.test.ts"
      to: "src/hooks/useAuth"
      via: "vi.mock"
      pattern: "vi\\.mock\\('./useAuth'"
---

<objective>
Comprehensive test coverage for useAssignments hook covering CRUD operations and all scheduling logic

Purpose: Verify useAssignments correctly creates assignments with proper task instance scheduling for all schedule types (once, daily, weekly, custom) and handles CRUD operations.

Output: `src/hooks/useAssignments.test.ts` with tests for CRUD and scheduling logic
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hook-tests/07-RESEARCH.md

@src/hooks/useAssignments.ts
@src/hooks/useAuth.tsx
@src/test/mocks/supabase.ts
@src/test/test-utils.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAssignments test file with CRUD tests</name>
  <files>src/hooks/useAssignments.test.ts</files>
  <action>
Create test suite for useAssignments CRUD operations:

1. Test file setup:
   - Import renderHook, waitFor, act from @testing-library/react
   - Import MemoryRouter for wrapper (useAssignments uses useAuth which uses useNavigate)
   - Mock @/integrations/supabase/client using mockSupabaseModule
   - Mock ./useAuth to return authenticated user
   - Mock ./use-toast to capture toast calls
   - Create wrapper function with MemoryRouter and QueryClientProvider

2. Mock useAuth (Pattern 5 from RESEARCH.md):
```typescript
vi.mock('./useAuth', () => ({
  useAuth: vi.fn(() => ({
    user: { id: 'coach-1', email: 'coach@test.com' },
    session: { access_token: 'mock-token' },
    loading: false,
    signOut: vi.fn(),
    sessionExpired: false,
    clearSessionExpired: vi.fn(),
  })),
}));
```

3. Mock useToast:
```typescript
const mockToast = vi.fn();
vi.mock('./use-toast', () => ({
  useToast: () => ({ toast: mockToast }),
}));
```

4. Test describe blocks:

   describe('createAssignment'):
   - Test: returns null when no user
   - Mock useAuth to return null user
   - Assert: createAssignment returns null

   - Test: creates assignment and task instances for individual assignee
   - Mock supabase responses in order:
     a. assignments.insert -> { id: 'assignment-1', ... }
     b. task_instances.insert -> [{ id: 'task-1', ... }]
   - Call createAssignment with schedule_type: 'once', assignee_id, tasks
   - Assert: assignment returned, toast called with "Assignment Created"

   describe('getTaskInstances'):
   - Test: returns filtered task instances
   - Mock supabase.from('task_instances').select() chain
   - Call getTaskInstances({ assigneeId: 'student-1' })
   - Assert: returns mocked data

   describe('updateTaskStatus'):
   - Test: updates task status to completed
   - Mock supabase.from('task_instances').update().eq()
   - Call updateTaskStatus(taskId, 'completed')
   - Assert: returns true, toast called with "Task Completed"

   - Test: handles error gracefully
   - Mock supabase to return error
   - Assert: returns false, error toast shown

5. beforeEach cleanup:
   - resetMockSupabase()
   - mockToast.mockClear()
  </action>
  <verify>npm run test -- src/hooks/useAssignments.test.ts --run</verify>
  <done>
    - CRUD tests pass: createAssignment, getTaskInstances, updateTaskStatus
    - Toast calls verified
    - Error handling verified
  </done>
</task>

<task type="auto">
  <name>Task 2: Add scheduling logic tests</name>
  <files>src/hooks/useAssignments.test.ts</files>
  <action>
Add tests for all schedule_type variations:

1. describe('scheduling logic'):

   describe('schedule_type: once'):
   - Test: creates single task on start_date
   - Input: schedule_type: 'once', start_date: '2026-01-25', tasks: [{ name: 'Task', day_offset: 0 }]
   - Assert: task_instances.insert called with 1 instance, scheduled_date = '2026-01-25'

   describe('schedule_type: daily'):
   - Test: creates tasks for each day in range
   - Input: schedule_type: 'daily', start_date: '2026-01-25', end_date: '2026-01-27' (3 days)
   - Assert: task_instances.insert called with 3 instances
   - Assert: scheduled_dates are '2026-01-25', '2026-01-26', '2026-01-27'

   describe('schedule_type: weekly'):
   - Test: creates tasks on same day of week as start_date
   - Input: schedule_type: 'weekly', start_date: '2026-01-25' (Saturday), end_date: '2026-02-08' (2 weeks)
   - Assert: task_instances for Saturdays: '2026-01-25', '2026-02-01', '2026-02-08'

   describe('schedule_type: custom'):
   - Test: creates tasks only on specified days
   - Input: schedule_type: 'custom', schedule_days: [1, 3, 5] (Mon, Wed, Fri)
   - Input: start_date: '2026-01-26' (Sunday), end_date: '2026-02-01' (Saturday)
   - Assert: tasks only on Mon (27), Wed (29), Fri (31)

2. Mock pattern for capturing insert calls:
```typescript
const insertedTasks: unknown[] = [];
getMockSupabase().queryBuilder.insert.mockImplementation((data) => {
  if (Array.isArray(data) && data[0]?.scheduled_date) {
    insertedTasks.push(...data);
  }
  return getMockSupabase().queryBuilder;
});
```

3. Verify dates by extracting scheduled_date from captured insertedTasks array
  </action>
  <verify>npm run test -- src/hooks/useAssignments.test.ts --run</verify>
  <done>
    - All 4 schedule_type tests pass (once, daily, weekly, custom)
    - Correct date calculations verified for each schedule type
    - day_offset respected for template-based assignments
  </done>
</task>

<task type="auto">
  <name>Task 3: Add group and template assignment tests</name>
  <files>src/hooks/useAssignments.test.ts</files>
  <action>
Add tests for group assignments and template-based assignments:

1. describe('group assignments'):
   - Test: creates task instances for all group members
   - Mock group_members.select to return 2 members
   - Input: group_id: 'group-1', schedule_type: 'once', tasks: [...]
   - Assert: task_instances created for both members (2 x tasks.length)

2. describe('template assignments'):
   - Test: uses template tasks with day_offset
   - Mock template_tasks.select to return tasks with various day_offsets
   - Input: template_id: 'template-1', start_date: '2026-01-25'
   - Assert: each task scheduled at start_date + day_offset

3. describe('no assignees'):
   - Test: shows warning toast when no assignees found
   - Mock group_members.select to return empty array
   - Assert: toast called with "Warning" and "No assignees found"

4. Handle Supabase mock response ordering:
   - Use setResponse/setArrayResponse in correct call order
   - For complex flows, use mockResolvedValueOnce sequences
  </action>
  <verify>npm run test -- src/hooks/useAssignments.test.ts --run</verify>
  <done>
    - Group assignment test passes (tasks created for all members)
    - Template assignment test passes (day_offset respected)
    - No assignees warning test passes
    - Full HOOK-02 requirement satisfied
  </done>
</task>

</tasks>

<verification>
- All useAssignments tests pass: `npm run test -- src/hooks/useAssignments.test.ts --run`
- No console warnings about missing act() wrappers
- CRUD operations tested (create, read, update)
- All 4 schedule types tested (once, daily, weekly, custom)
</verification>

<success_criteria>
- HOOK-02 requirement satisfied: useAssignments has tests for CRUD operations and scheduling logic
- createAssignment tested for individual, group, and template assignments
- getTaskInstances tested with filters
- updateTaskStatus tested for success and error cases
- All schedule_type values tested with correct date calculations
</success_criteria>

<output>
After completion, create `.planning/phases/07-hook-tests/07-02-SUMMARY.md`
</output>

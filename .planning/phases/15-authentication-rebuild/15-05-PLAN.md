---
phase: 15-authentication-rebuild
plan: 05
type: execute
wave: 3
depends_on: ["15-03"]
files_modified:
  - src/hooks/useProfile.ts
  - src/App.tsx
  - src/components/auth/CoachAuth.tsx
  - src/components/auth/StudentAuth.tsx
autonomous: true

must_haves:
  truths:
    - "useProfile has retry logic for profile not found immediately after OAuth"
    - "Email/password authentication UI is removed from CoachAuth and StudentAuth"
    - "Login-via-code for authentication is removed (QR/code for class joining remains)"
    - "localStorage role tracking is removed from auth components"
  artifacts:
    - path: "src/hooks/useProfile.ts"
      provides: "Profile hook with retry logic"
      contains: "retry"
    - path: "src/components/auth/CoachAuth.tsx"
      provides: "Removed or repurposed (no email auth)"
    - path: "src/components/auth/StudentAuth.tsx"
      provides: "Only QR/code for class joining, no email auth"
  key_links:
    - from: "useProfile.ts"
      to: "supabase.from('profiles')"
      via: "useQuery with retry"
      pattern: "retry.*failureCount"
---

<objective>
Enhance useProfile with retry logic, remove email/password auth flows, and clean up localStorage role tracking.

Purpose: Complete the auth cleanup by removing deprecated auth methods and ensuring profile loading is robust.

Output: Enhanced useProfile.ts with retry, stripped-down CoachAuth/StudentAuth, updated App.tsx routes.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-authentication-rebuild/15-RESEARCH.md
@.planning/phases/15-authentication-rebuild/15-03-SUMMARY.md

Source files to read:
@src/hooks/useProfile.ts
@src/components/auth/CoachAuth.tsx
@src/components/auth/StudentAuth.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry logic to useProfile for trigger timing edge case</name>
  <files>src/hooks/useProfile.ts</files>
  <action>
Enhance the useProfile hook to handle the edge case where profile isn't available immediately after OAuth:

1. Update the useQuery configuration to include retry logic:

```typescript
const {
  data: profile,
  isPending,
  isFetching,
  isError,
  error,
  refetch,
} = useQuery({
  queryKey: queryKeys.profile.current(user?.id ?? ''),
  queryFn: () => fetchOrCreateProfile(user!.id, user!.email, user!.user_metadata),
  enabled: !!user,
  // Retry logic for profile not found (trigger timing edge case)
  retry: (failureCount, error: any) => {
    // Retry up to 3 times if profile not found (PGRST116)
    // This handles the rare case where React Query fires before trigger completes
    if (error?.code === 'PGRST116' && failureCount < 3) {
      return true;
    }
    // Also retry on network errors
    if (error?.message?.includes('network') && failureCount < 2) {
      return true;
    }
    return false;
  },
  retryDelay: (attemptIndex) => Math.min(100 * 2 ** attemptIndex, 1000), // 100ms, 200ms, 400ms
});
```

2. Update the fetchOrCreateProfile function to NOT auto-create profile (the trigger handles this now):

```typescript
async function fetchProfile(
  userId: string,
): Promise<Profile> {
  const { data, error } = await supabase
    .from("profiles")
    .select("*")
    .eq("user_id", userId)
    .single();

  if (error) {
    // Let retry logic handle profile not found
    throw error;
  }

  return data;
}
```

Actually, keep the auto-create fallback for backwards compatibility with existing users who might not have profiles. But remove the hardcoded "coach" role - use null and let the user go through proper role selection:

```typescript
async function fetchOrCreateProfile(
  userId: string,
  email: string | undefined,
  userMetadata: Record<string, unknown> | undefined
): Promise<Profile> {
  const { data, error } = await supabase
    .from("profiles")
    .select("*")
    .eq("user_id", userId)
    .single();

  if (error) {
    // If profile doesn't exist, create one (backwards compatibility)
    if (error.code === "PGRST116") {
      const newProfile = {
        user_id: userId,
        display_name: (userMetadata?.full_name as string) || email?.split("@")[0] || null,
        email: email,
        role: (userMetadata?.role as string) || null, // Use role from metadata, not hardcoded
      };

      const { data: createdProfile, error: createError } = await supabase
        .from("profiles")
        .insert(newProfile)
        .select()
        .single();

      if (createError) throw createError;
      return createdProfile;
    }
    throw error;
  }

  return data;
}
```

Key changes:
- Add retry with exponential backoff for PGRST116 errors
- Remove hardcoded "coach" role in fallback creation
- Use role from userMetadata if available
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. useProfile has retry configuration
  </verify>
  <done>useProfile has retry logic for profile not found immediately after OAuth</done>
</task>

<task type="auto">
  <name>Task 2A: Update CoachAuth to redirect-only + remove localStorage</name>
  <files>src/components/auth/CoachAuth.tsx</files>
  <action>
Since Auth.tsx now handles role selection with OAuth, CoachAuth is no longer needed for authentication. Simplify it to just redirect to the main auth page (in case any old links exist).

Also remove any `localStorage.setItem("intended_role"` or similar role tracking.

```typescript
import { useEffect } from "react";
import { useNavigate } from "react-router-dom";

// Deprecated: Auth is now handled via role selection on the main auth page
export function CoachAuth() {
  const navigate = useNavigate();

  useEffect(() => {
    // Redirect to main auth page
    navigate("/", { replace: true });
  }, [navigate]);

  return null;
}
```
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. No localStorage.setItem("intended_role") in CoachAuth.tsx
  </verify>
  <done>CoachAuth simplified to redirect-only, localStorage role tracking removed</done>
</task>

<task type="auto">
  <name>Task 2B: Update StudentAuth to class-joining only</name>
  <files>src/components/auth/StudentAuth.tsx</files>
  <action>
Keep only the class joining functionality (QR scanner and class code), remove email/password auth:

```typescript
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { supabase } from "@/integrations/supabase/client";
import { useToast } from "@/hooks/use-toast";
import { handleError } from "@/lib/error";
import { Button } from "@/components/ui/button";
import { QRScanner } from "./QRScanner";
import { ClassCodeForm } from "./ClassCodeForm";
import { QrCode, Keyboard, ArrowLeft } from "lucide-react";

// StudentAuth is now only for joining classes via QR/code (not for authentication)
export function StudentAuth() {
  const [view, setView] = useState<"options" | "qr" | "code">("options");
  const [isProcessingQR, setIsProcessingQR] = useState(false);

  const navigate = useNavigate();
  const { toast } = useToast();

  const handleQRScan = async (qrData: string) => {
    setIsProcessingQR(true);
    try {
      const { data, error } = await supabase.rpc("validate_qr_token", { token: qrData });

      if (error || !data || (Array.isArray(data) && data.length === 0)) {
        toast({ title: "Invalid QR Code", description: "This QR code is invalid or has expired.", variant: "destructive" });
        setView("options");
        return;
      }

      const session = Array.isArray(data) ? data[0] : data;
      toast({ title: "Joined Class!", description: `Welcome to ${session?.session_name || 'Class'}` });
      navigate("/app");
    } catch (error) {
      handleError(error, { component: 'StudentAuth', action: 'process QR code' });
    } finally {
      setIsProcessingQR(false);
      setView("options");
    }
  };

  const handleClassCodeSuccess = (sessionName: string) => {
    toast({ title: "Joined Class!", description: `Welcome to ${sessionName}` });
    navigate("/app");
  };

  if (view === "qr") {
    return <QRScanner onScan={handleQRScan} onCancel={() => setView("options")} isProcessing={isProcessingQR} />;
  }

  if (view === "code") {
    return <ClassCodeForm onSuccess={handleClassCodeSuccess} onCancel={() => setView("options")} />;
  }

  return (
    <div className="space-y-4">
      <Button variant="ghost" className="gap-2 -ml-2 mb-2 p-0 h-auto hover:bg-transparent" onClick={() => navigate("/app")}>
        <ArrowLeft className="w-4 h-4" /> Back to App
      </Button>
      <h2 className="text-xl font-semibold text-center mb-6">Join a Class</h2>

      <div className="space-y-3">
        <Button variant="outline" className="w-full h-14 justify-start gap-4 text-left" onClick={() => setView("qr")}>
          <div className="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
            <QrCode className="w-5 h-5 text-primary" />
          </div>
          <div>
            <div className="font-medium">Scan QR Code</div>
            <div className="text-xs text-muted-foreground">Use your camera</div>
          </div>
        </Button>
        <Button variant="outline" className="w-full h-14 justify-start gap-4 text-left" onClick={() => setView("code")}>
          <div className="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
            <Keyboard className="w-5 h-5 text-primary" />
          </div>
          <div>
            <div className="font-medium">Enter Class Code</div>
            <div className="text-xs text-muted-foreground">Type the 6-character code</div>
          </div>
        </Button>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. No email/password forms in StudentAuth
  </verify>
  <done>StudentAuth only has QR/code for class joining, no email auth</done>
</task>

<task type="auto">
  <name>Task 2C: Remove deprecated routes from App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Remove the /login/coach and /login/student routes (they're no longer needed):

Find and remove these lines:
```typescript
<Route path="/login/coach" element={<Index />} />
<Route path="/login/student" element={<Index />} />
```

Keep only:
```typescript
<Route path="/" element={<Index />} />
<Route path="/login" element={<Index />} />
```

Do NOT add a new /join route - students join classes from within the app.
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. /login/coach and /login/student routes removed from App.tsx
3. / and /login routes still exist
  </verify>
  <done>/login/coach and /login/student routes removed, / and /login routes preserved</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. useProfile has retry configuration with exponential backoff
3. CoachAuth just redirects to main auth page
4. StudentAuth only has QR/code for class joining
5. No localStorage role tracking
6. /login/coach and /login/student routes removed
</verification>

<success_criteria>
- useProfile retries up to 3 times for PGRST116 errors
- Email/password authentication UI is completely removed
- Login-via-code for AUTH is removed (QR/code for class joining is preserved)
- No localStorage usage for role tracking
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-authentication-rebuild/15-05-SUMMARY.md`
</output>

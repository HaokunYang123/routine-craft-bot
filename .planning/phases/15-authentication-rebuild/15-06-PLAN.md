---
phase: 15-authentication-rebuild
plan: 06
type: execute
wave: 3
depends_on: ["15-03", "15-04", "15-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can complete full OAuth flow from role selection to dashboard"
    - "Profile is created with correct role after OAuth"
    - "User is routed to correct dashboard based on role"
    - "Error pages have working logout buttons"
---

<objective>
End-to-end verification of the authentication rebuild with manual testing.

Purpose: Validate the complete authentication flow works as expected before marking the phase complete.

Output: Verified authentication flow, confirmation that all requirements are met.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-authentication-rebuild/15-CONTEXT.md
@.planning/phases/15-authentication-rebuild/15-01-SUMMARY.md
@.planning/phases/15-authentication-rebuild/15-02-SUMMARY.md
@.planning/phases/15-authentication-rebuild/15-03-SUMMARY.md
@.planning/phases/15-authentication-rebuild/15-04-SUMMARY.md
@.planning/phases/15-authentication-rebuild/15-05-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow with Google OAuth, role selection, and role-based routing</what-built>
  <how-to-verify>
**Preparation:**
1. Start the dev server: `npm run dev`
2. Open browser to http://localhost:5173 (or your configured port)
3. Make sure you're logged out (check browser dev tools > Application > Local Storage and clear any Supabase auth data if needed)

**Test 1: Coach Sign Up Flow**
1. Visit the home page - you should see "Welcome to Routine Craft" with two role cards
2. Click the "Coach" card
3. Google OAuth popup should appear (or redirect, depending on browser)
4. Complete Google authentication
5. After auth, you should see "Setting up your account..." loading screen briefly
6. You should land on /dashboard (coach dashboard)
7. Verify profile was created: In browser console, run:
   ```javascript
   const { data } = await supabase.auth.getUser();
   const { data: profile } = await supabase.from('profiles').select('*').eq('user_id', data.user.id).single();
   console.log(profile);
   ```
   Profile should have `role: 'coach'`

**Test 2: Returning User Auto-Redirect**
1. While still logged in as coach, navigate to http://localhost:5173/
2. You should be auto-redirected to /dashboard (not see role selection)

**Test 3: Student Sign Up Flow**
1. Log out (use the profile menu or clear auth from dev tools)
2. Visit home page
3. Click the "Student" card
4. Complete Google OAuth
5. After auth, you should land on /app (student home)
6. Verify profile has `role: 'student'`

**Test 4: Error Page Logout**
1. While logged in, navigate to a non-existent page like /this-does-not-exist
2. You should see the 404 page with "Go to Dashboard" and "Log Out" buttons
3. Click "Log Out"
4. You should be redirected to the home page (role selection)
5. You should now see the role selection cards (not auto-redirected)

**Test 5: No Email/Password Option**
1. Verify there is NO email/password option visible on the auth page
2. Verify the only way to authenticate is via the role cards which trigger Google OAuth

**Test 6: Loading States**
1. Click a role card
2. While waiting for OAuth popup, verify the selected card shows a loading spinner
3. If you close the popup without completing OAuth, the loading should stop (no error message)

**Expected Results:**
- [ ] Coach sign up lands on /dashboard with role: 'coach' in profile
- [ ] Returning user auto-redirected to their dashboard
- [ ] Student sign up lands on /app with role: 'student' in profile
- [ ] 404 page has working logout button
- [ ] No email/password option visible
- [ ] Loading states work on role cards
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass.
If any issues, describe what went wrong and which test failed.
  </resume-signal>
</task>

</tasks>

<verification>
All 6 test scenarios pass as described above.
</verification>

<success_criteria>
Phase 15 Success Criteria (from ROADMAP.md):
1. User lands on role selection page showing "I am a Coach" and "I am a Student" before any authentication
2. User can sign up/sign in via Google OAuth only (no email/password option visible)
3. User profile exists with correct role immediately after OAuth completion (zero latency)
4. User is routed to correct dashboard based on role from database (not localStorage)
5. User can log out from error pages (NotFound, ErrorFallback) as emergency exit
</success_criteria>

<output>
After completion, create `.planning/phases/15-authentication-rebuild/15-06-SUMMARY.md`
</output>

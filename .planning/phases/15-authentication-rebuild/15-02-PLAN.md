---
phase: 15-authentication-rebuild
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/AuthCallback.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "OAuth callback page handles the redirect from Google OAuth"
    - "Role is extracted from URL and used to update profile if needed"
    - "User is routed to correct dashboard based on profile role from database"
  artifacts:
    - path: "src/pages/AuthCallback.tsx"
      provides: "OAuth callback handler"
      min_lines: 40
    - path: "src/App.tsx"
      provides: "Route for /auth/callback"
      contains: "AuthCallback"
  key_links:
    - from: "AuthCallback.tsx"
      to: "/dashboard or /app"
      via: "navigate based on profile.role"
      pattern: "navigate.*dashboard|navigate.*app"
---

<objective>
Create the OAuth callback page that processes the redirect from Google OAuth, ensures profile has correct role, and routes user to appropriate dashboard.

Purpose: Handle the OAuth flow completion, ensuring the role from URL is persisted and user lands on correct dashboard.

Output: New `AuthCallback.tsx` page component, updated `App.tsx` with route.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-authentication-rebuild/15-RESEARCH.md

Source files to read:
@src/App.tsx
@src/integrations/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuthCallback page component</name>
  <files>src/pages/AuthCallback.tsx</files>
  <action>
Create a new page component at `src/pages/AuthCallback.tsx` that:

1. Imports:
   - `useEffect, useState` from react
   - `useNavigate, useSearchParams` from react-router-dom
   - `supabase` from @/integrations/supabase/client
   - `Loader2` from lucide-react

2. Component structure:
   ```typescript
   export default function AuthCallback() {
     const navigate = useNavigate();
     const [searchParams] = useSearchParams();
     const role = searchParams.get('role') as 'coach' | 'student' | null;
     const [error, setError] = useState<string | null>(null);

     useEffect(() => {
       const handleCallback = async () => {
         try {
           // Supabase handles the OAuth code exchange automatically
           const { data: { session }, error: sessionError } = await supabase.auth.getSession();

           if (sessionError || !session) {
             // Auth failed - redirect to home
             navigate('/', { replace: true });
             return;
           }

           // If we have a role from URL and this is a new user, update their profile
           // (Trigger should have created profile, but ensure role is correct)
           if (role) {
             // Update profile role only if it's null (newly created by trigger with default)
             await supabase
               .from('profiles')
               .update({ role })
               .eq('user_id', session.user.id)
               .is('role', null);
           }

           // Fetch profile to determine where to route
           const { data: profile, error: profileError } = await supabase
             .from('profiles')
             .select('role')
             .eq('user_id', session.user.id)
             .single();

           if (profileError || !profile) {
             // Profile doesn't exist yet - retry once after short delay
             await new Promise(resolve => setTimeout(resolve, 500));
             const { data: retryProfile } = await supabase
               .from('profiles')
               .select('role')
               .eq('user_id', session.user.id)
               .single();

             if (!retryProfile) {
               setError('Profile setup failed. Please try again.');
               return;
             }

             // Route based on retried profile
             if (retryProfile.role === 'coach') {
               navigate('/dashboard', { replace: true });
             } else {
               navigate('/app', { replace: true });
             }
             return;
           }

           // Route based on role
           if (profile.role === 'coach') {
             navigate('/dashboard', { replace: true });
           } else {
             navigate('/app', { replace: true });
           }
         } catch (err) {
           console.error('Auth callback error:', err);
           setError('Authentication failed. Please try again.');
         }
       };

       handleCallback();
     }, [navigate, role]);

     if (error) {
       return (
         <div className="min-h-screen flex items-center justify-center bg-background">
           <div className="text-center space-y-4">
             <p className="text-destructive">{error}</p>
             <a href="/" className="text-primary underline">Return to Home</a>
           </div>
         </div>
       );
     }

     return (
       <div className="min-h-screen flex items-center justify-center bg-background">
         <div className="text-center space-y-4">
           <Loader2 className="w-8 h-8 animate-spin text-primary mx-auto" />
           <p className="text-muted-foreground">Setting up your account...</p>
         </div>
       </div>
     );
   }
   ```

Key behaviors per CONTEXT.md:
- Full-screen loading with message "Setting up your account..."
- Routes to correct dashboard based on database role (not localStorage)
- Handles profile timing edge case with retry
  </action>
  <verify>File exists and TypeScript compiles: `npm run build`</verify>
  <done>AuthCallback page handles OAuth redirect, updates role if needed, and routes to correct dashboard</done>
</task>

<task type="auto">
  <name>Task 2: Add /auth/callback route to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Modify `src/App.tsx` to:

1. Add import for AuthCallback:
   ```typescript
   import AuthCallback from "./pages/AuthCallback";
   ```

2. Add the route BEFORE the catch-all route (`path="*"`):
   ```typescript
   {/* OAuth Callback */}
   <Route path="/auth/callback" element={<AuthCallback />} />
   ```

Place it after the login routes and before the dashboard routes for clarity. The route should NOT be wrapped in RouteErrorBoundary since AuthCallback handles its own errors and redirects.
  </action>
  <verify>
1. npm run build passes
2. Route exists in App.tsx
  </verify>
  <done>App.tsx includes /auth/callback route pointing to AuthCallback component</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. AuthCallback.tsx exists and handles OAuth callback
3. App.tsx has /auth/callback route
</verification>

<success_criteria>
- AuthCallback component created with loading state and error handling
- OAuth callback extracts role from URL and updates profile if needed
- User is routed to /dashboard (coach) or /app (student) based on database role
- Route registered in App.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/15-authentication-rebuild/15-02-SUMMARY.md`
</output>

---
phase: 15-authentication-rebuild
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - src/components/auth/RoleSelection.tsx
  - src/pages/Auth.tsx
autonomous: true

must_haves:
  truths:
    - "User sees two large role cards (Coach and Student) on landing page"
    - "Clicking a card immediately triggers Google OAuth popup"
    - "Loading indicator appears on selected card while OAuth is in progress"
    - "Returning user with session is auto-redirected to their dashboard"
  artifacts:
    - path: "src/components/auth/RoleSelection.tsx"
      provides: "Role cards that trigger OAuth directly"
      min_lines: 80
    - path: "src/pages/Auth.tsx"
      provides: "Landing page with role selection"
      contains: "RoleSelection"
  key_links:
    - from: "RoleSelection.tsx"
      to: "useGoogleAuth"
      via: "signInWithGoogle(role)"
      pattern: "signInWithGoogle.*coach|signInWithGoogle.*student"
---

<objective>
Rebuild the role selection UI to trigger Google OAuth directly from card click, with loading states and error handling.

Purpose: Implement the new UX flow where role selection immediately leads to OAuth (no intermediate screens).

Output: Rebuilt `RoleSelection.tsx` with OAuth integration, simplified `Auth.tsx` as landing page.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-authentication-rebuild/15-CONTEXT.md
@.planning/phases/15-authentication-rebuild/15-RESEARCH.md
@.planning/phases/15-authentication-rebuild/15-01-SUMMARY.md

Source files to read:
@src/components/auth/RoleSelection.tsx
@src/pages/Auth.tsx
@src/hooks/useGoogleAuth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild RoleSelection.tsx with direct OAuth trigger</name>
  <files>src/components/auth/RoleSelection.tsx</files>
  <action>
Completely rebuild `RoleSelection.tsx` to:

1. Remove navigation to separate login routes
2. Import and use `useGoogleAuth` hook
3. Add state for tracking which card is loading and any errors

Structure:
```typescript
import { useState } from "react";
import { useGoogleAuth } from "@/hooks/useGoogleAuth";
import { Button } from "@/components/ui/button";
import { School, GraduationCap, Loader2, AlertCircle } from "lucide-react";

type Role = 'coach' | 'student';

export function RoleSelection() {
  const { signInWithGoogle, loading, error, clearError } = useGoogleAuth();
  const [selectedRole, setSelectedRole] = useState<Role | null>(null);

  const handleRoleSelect = async (role: Role) => {
    setSelectedRole(role);
    clearError();
    await signInWithGoogle(role);
    // If we get here without redirect, OAuth popup was closed
    setSelectedRole(null);
  };

  return (
    <div className="space-y-6">
      <h2 className="text-xl font-semibold text-center">I am a...</h2>

      <div className="grid grid-cols-2 gap-4">
        {/* Coach Card */}
        <Button
          variant="outline"
          className="h-36 flex flex-col items-center justify-center gap-3 hover:border-primary hover:bg-primary/5 relative"
          onClick={() => handleRoleSelect('coach')}
          disabled={loading}
        >
          {selectedRole === 'coach' && loading ? (
            <Loader2 className="w-6 h-6 animate-spin text-primary" />
          ) : (
            <div className="w-14 h-14 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
              <School className="w-7 h-7" />
            </div>
          )}
          <div className="text-center">
            <span className="font-medium text-lg text-foreground block">Coach</span>
            <span className="text-xs text-muted-foreground">Manage students & tasks</span>
          </div>
        </Button>

        {/* Student Card */}
        <Button
          variant="outline"
          className="h-36 flex flex-col items-center justify-center gap-3 hover:border-primary hover:bg-primary/5 relative"
          onClick={() => handleRoleSelect('student')}
          disabled={loading}
        >
          {selectedRole === 'student' && loading ? (
            <Loader2 className="w-6 h-6 animate-spin text-primary" />
          ) : (
            <div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center text-green-600">
              <GraduationCap className="w-7 h-7" />
            </div>
          )}
          <div className="text-center">
            <span className="font-medium text-lg text-foreground block">Student</span>
            <span className="text-xs text-muted-foreground">Complete assignments</span>
          </div>
        </Button>
      </div>

      {/* Error message */}
      {error && (
        <div className="flex items-center gap-2 text-sm text-destructive bg-destructive/10 p-3 rounded-lg">
          <AlertCircle className="w-4 h-4 flex-shrink-0" />
          <span>{error}</span>
        </div>
      )}

      {/* Troubleshooting link */}
      <div className="text-center">
        <button
          type="button"
          onClick={() => {
            // Simple alert with tips - could be a modal in future
            alert(
              "Trouble signing in?\n\n" +
              "1. Make sure popups are enabled for this site\n" +
              "2. Try using Chrome or Firefox\n" +
              "3. Clear your browser cache\n" +
              "4. If using an ad blocker, try disabling it"
            );
          }}
          className="text-xs text-muted-foreground hover:text-foreground underline"
        >
          Trouble signing in?
        </button>
      </div>
    </div>
  );
}
```

Key behaviors per CONTEXT.md:
- Two large cards side by side (Coach left, Student right)
- Each card has icon, title, and tagline
- Clicking immediately triggers OAuth (no intermediate screen)
- Loading indicator on selected card while OAuth popup is open
- Silent reset if popup closed without completing
- Error message below cards with retry option
- Troubleshooting link with tips
  </action>
  <verify>TypeScript compiles without errors: `npm run build`</verify>
  <done>RoleSelection shows two role cards that trigger OAuth directly with loading states</done>
</task>

<task type="auto">
  <name>Task 2: Simplify Auth.tsx as landing page</name>
  <files>src/pages/Auth.tsx</files>
  <action>
Simplify `Auth.tsx` to be a clean landing page:

1. Remove path-based rendering logic (no more /login/coach, /login/student)
2. Always show RoleSelection component
3. Add auto-redirect for logged-in users visiting this page
4. Remove imports for CoachAuth and StudentAuth

```typescript
import { useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { supabase } from "@/integrations/supabase/client";
import { GraduationCap, Loader2 } from "lucide-react";
import { RoleSelection } from "@/components/auth/RoleSelection";
import { useState } from "react";

const Auth = () => {
  const navigate = useNavigate();
  const [checking, setChecking] = useState(true);

  useEffect(() => {
    // Check if user is already logged in and redirect to their dashboard
    const checkSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();

      if (session) {
        // Fetch profile to determine role
        const { data: profile } = await supabase
          .from("profiles")
          .select("role")
          .eq("user_id", session.user.id)
          .single();

        if (profile?.role === "coach") {
          navigate("/dashboard", { replace: true });
        } else if (profile?.role === "student") {
          navigate("/app", { replace: true });
        }
      }
      setChecking(false);
    };

    checkSession();
  }, [navigate]);

  // Show loading while checking session
  if (checking) {
    return (
      <div className="min-h-screen gradient-subtle flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="min-h-screen gradient-subtle flex items-center justify-center p-4">
      <div className="w-full max-w-md">
        <div className="bg-card rounded-2xl shadow-elevated border border-border p-8">
          {/* Logo and Welcome */}
          <div className="flex items-center justify-center gap-3 mb-2">
            <div className="w-12 h-12 rounded-xl gradient-hero flex items-center justify-center shadow-soft">
              <GraduationCap className="w-6 h-6 text-primary-foreground" />
            </div>
          </div>
          <div className="text-center mb-8">
            <h1 className="text-2xl font-semibold text-foreground">Welcome to Routine Craft</h1>
            <p className="text-sm text-muted-foreground mt-1">Task Management for Students & Coaches</p>
          </div>

          {/* Role Selection */}
          <RoleSelection />
        </div>

        {/* Footer */}
        <p className="text-center text-xs text-muted-foreground mt-6">
          By continuing, you agree to our Terms of Service and Privacy Policy.
        </p>
      </div>
    </div>
  );
};

export default Auth;
```

Key behaviors per CONTEXT.md:
- App logo + welcome text above cards ("Welcome to Routine Craft")
- Shows RoleSelection directly (no intermediate navigation)
- Returning users are auto-redirected to their dashboard
- Loading state while checking session
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. Auth.tsx no longer imports CoachAuth/StudentAuth
  </verify>
  <done>Auth.tsx is a clean landing page with role selection and auto-redirect for logged-in users</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. RoleSelection directly triggers OAuth on card click
3. Auth.tsx shows role selection and auto-redirects logged-in users
</verification>

<success_criteria>
- User sees welcome message and two role cards on landing page
- Clicking a card triggers Google OAuth with loading indicator
- Error messages appear inline below cards
- Troubleshooting link available
- Logged-in users visiting / are auto-redirected to their dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/15-authentication-rebuild/15-03-SUMMARY.md`
</output>

---
phase: 10-simple-hook-migration
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/hooks/useGroups.ts
  - src/hooks/useGroups.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees loading indicator when useGroups fetches (isPending = true)"
    - "User sees cached groups instantly on navigation (no refetch within staleTime)"
    - "User sees error message when groups fetch fails (isError = true)"
    - "Component interface unchanged (groups, loading, fetchGroups, mutations)"
  artifacts:
    - path: "src/hooks/useGroups.ts"
      provides: "React Query-powered groups hook"
      contains: "useQuery"
      exports: ["useGroups", "Group", "GroupMember"]
    - path: "src/hooks/useGroups.test.tsx"
      provides: "Updated tests for migrated useGroups hook"
      contains: ["describe", "QueryClientProvider"]
  key_links:
    - from: "src/hooks/useGroups.ts"
      to: "src/lib/queries/keys.ts"
      via: "queryKeys.groups.list"
      pattern: "queryKeys\\.groups\\.list"
    - from: "src/hooks/useGroups.ts"
      to: "@tanstack/react-query"
      via: "useQuery import"
      pattern: "import.*useQuery.*@tanstack/react-query"
---

<objective>
Migrate useGroups hook from useState/useEffect to React Query useQuery pattern.

Purpose: Second migration validates pattern with more complex hook (multiple mutations, member counts computation).
Output: Working useGroups hook using React Query with backward-compatible interface + updated test suite.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-simple-hook-migration/10-CONTEXT.md
@.planning/phases/10-simple-hook-migration/10-RESEARCH.md
@.planning/phases/10-simple-hook-migration/10-01-SUMMARY.md

@src/hooks/useGroups.ts
@src/hooks/useGroups.test.tsx
@src/lib/queries/keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate useGroups to React Query</name>
  <files>src/hooks/useGroups.ts</files>
  <action>
Replace useState/useEffect pattern with useQuery:

1. Add imports:
   ```typescript
   import { useQuery, useQueryClient } from '@tanstack/react-query';
   import { queryKeys } from '@/lib/queries/keys';
   ```

2. Extract queryFn to separate async function `fetchGroupsWithCounts(userId)`:
   - Move the groups fetch + member count computation logic
   - Return Group[] (not void)
   - Throw errors (don't catch internally - let React Query handle)
   ```typescript
   async function fetchGroupsWithCounts(userId: string): Promise<Group[]> {
     const { data, error } = await supabase
       .from("groups")
       .select("*")
       .eq("coach_id", userId)
       .order("created_at", { ascending: false });

     if (error) throw error;

     // Get member counts for each group
     const groupsWithCounts = await Promise.all(
       (data || []).map(async (group) => {
         const { count } = await supabase
           .from("group_members")
           .select("*", { count: "exact", head: true })
           .eq("group_id", group.id);
         return { ...group, member_count: count || 0 };
       })
     );

     return groupsWithCounts;
   }
   ```

3. Replace hook internals:
   ```typescript
   const queryClient = useQueryClient();

   const {
     data: groups,
     isPending,
     isFetching,
     isError,
     error,
     refetch,
   } = useQuery({
     queryKey: queryKeys.groups.list(user?.id ?? ''),
     queryFn: () => fetchGroupsWithCounts(user!.id),
     enabled: !!user,
   });
   ```

4. Keep return interface backward-compatible:
   ```typescript
   return {
     groups: groups ?? [],          // Coerce undefined to empty array
     loading: isPending,            // Keep "loading" name
     isFetching,                    // NEW: for background refresh indicator
     isError,                       // NEW: for error UI
     error,                         // NEW: for error details
     fetchGroups: refetch,          // Manual retry
     createGroup,                   // Keep existing
     updateGroup,                   // Keep existing
     deleteGroup,                   // Keep existing
     addMember,                     // Keep existing
     removeMember,                  // Keep existing
     getGroupMembers,               // Keep existing
   };
   ```

5. Update all mutation functions to use queryClient.invalidateQueries:
   - createGroup: after success, `await queryClient.invalidateQueries({ queryKey: queryKeys.groups.list(user.id) })`
   - updateGroup: same invalidation
   - deleteGroup: can keep optimistic local filter OR use invalidation
   - addMember: invalidate to get updated member counts
   - removeMember: invalidate to get updated member counts

IMPORTANT:
- Remove useState for groups and loading
- Remove useEffect that calls fetchGroups
- Remove useCallback wrapper from fetchGroups
- Keep Group and GroupMember interface exports unchanged
- Remove toast dependency from useCallback deps (not needed anymore)
- Global error handler handles toasts - do NOT add per-hook toast on fetch errors
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Grep for "useQuery" in useGroups.ts - should find import and usage.
  </verify>
  <done>
useGroups hook uses React Query useQuery with:
- queryKeys.groups.list for cache key
- enabled: !!user guard
- isPending/isFetching/isError exposed
- groups ?? [] for backward compatibility
- All mutations use invalidateQueries
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useGroups tests for React Query</name>
  <files>src/hooks/useGroups.test.tsx</files>
  <action>
Update existing test file to work with React Query:

1. Add QueryClientProvider to wrapper:
   ```typescript
   import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

   function createWrapper() {
     const queryClient = new QueryClient({
       defaultOptions: { queries: { retry: false } },
     });
     return ({ children }: { children: React.ReactNode }) => (
       <QueryClientProvider client={queryClient}>
         <MemoryRouter>{children}</MemoryRouter>
       </QueryClientProvider>
     );
   }
   ```

2. Existing tests should mostly work as-is because:
   - Same Supabase mock pattern
   - Same loading/groups interface
   - Tests already use waitFor for async

3. Add new tests for React Query-specific behavior:
   - `exposes isFetching for background refresh` - isFetching true during refetch
   - `exposes isError on fetch failure` - isError true when query fails
   - `cache invalidation after createGroup` - invalidateQueries called

4. Fix any tests that rely on implementation details:
   - Tests checking setGroups calls -> now check query cache or final state
   - Tests checking specific re-render patterns -> may need adjustment

5. Ensure all 20+ existing test cases still pass with the new implementation.
  </action>
  <verify>
Run `npm test src/hooks/useGroups.test.tsx` - all tests pass.
  </verify>
  <done>
useGroups.test.tsx updated with:
- QueryClientProvider in wrapper
- Existing tests pass unchanged
- New tests for isFetching, isError, invalidation
- No test regressions
  </done>
</task>

</tasks>

<verification>
1. `npm run build` - TypeScript compiles without errors
2. `npm test src/hooks/useGroups.test.tsx` - all tests pass
3. `npm test` - all tests pass (no regressions)
4. `grep -n "useQuery" src/hooks/useGroups.ts` - confirms React Query usage
5. `grep -n "queryKeys.groups" src/hooks/useGroups.ts` - confirms key factory usage
6. `grep -n "invalidateQueries" src/hooks/useGroups.ts` - confirms cache invalidation in mutations
</verification>

<success_criteria>
- useGroups.ts uses useQuery with queryKeys.groups.list
- Return interface unchanged (groups, loading, fetchGroups, mutations)
- New properties exposed: isFetching, isError, error
- All mutation functions use invalidateQueries
- Test suite updated with QueryClientProvider
- All existing tests pass + new React Query behavior tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-simple-hook-migration/10-02-SUMMARY.md`
</output>
